<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#EFEFEC" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1A1E1B" media="(prefers-color-scheme: dark)">
    <meta name="color-scheme" content="light dark">
    <meta name="description" content="Arava Distillery — Production Control System">
    <title>Arava Distillery · Preview</title>
    <script>
      (function() {
        var lang = localStorage.getItem('factory_lang') || 'he';
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'he' ? 'rtl' : 'ltr';
        var storedTheme = localStorage.getItem('factory_theme');
        if (storedTheme) {
          document.documentElement.setAttribute('data-theme', storedTheme);
        } else {
          var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        }
      })();
    </script>
    <style>
/* ============================================================
   Factory Control — Arava Distillery Design System
   Cream/light by default • Forest-green dark mode
   ============================================================ */

/* ── Color Tokens — Arava Distillery Brand ── */
:root {
  /* Backgrounds — warm cream palette */
  --bg:          #EFEFEC;
  --bg-card:     #FAFAF8;
  --bg-input:    #FAFAF8;
  --bg-surface:  #E8E8E4;
  --bg-elevated: #FFFFFF;

  /* Text — near-black brand */
  --text:           #252525;
  --text-secondary: rgba(37, 37, 37, 0.65);
  --text-muted:     rgba(37, 37, 37, 0.38);

  /* Accent — forest green */
  --accent:      #2C332F;
  --accent-hover:#1E2420;
  --accent-bg:   rgba(44, 51, 47, 0.08);
  --accent-bg2:  rgba(44, 51, 47, 0.14);

  /* Semantic — earthy palette */
  --success:     #3F5147;
  --success-bg:  rgba(63, 81, 71, 0.12);
  --warning:     #8B6914;
  --warning-bg:  rgba(139, 105, 20, 0.12);
  --danger:      #8B2E2E;
  --danger-bg:   rgba(139, 46, 46, 0.12);

  /* Borders */
  --border:     rgba(37, 37, 37, 0.14);
  --separator:  rgba(37, 37, 37, 0.08);

  /* Radii — sharp, artisanal brand-aligned */
  --radius:    6px;
  --radius-sm: 3px;
  --radius-xs: 2px;

  /* Shadows — warm toned */
  --shadow:    0 2px 12px rgba(37, 37, 37, 0.06), 0 1px 3px rgba(37, 37, 37, 0.04);
  --shadow-lg: 0 8px 32px rgba(37, 37, 37, 0.10), 0 2px 8px rgba(37, 37, 37, 0.04);

  /* Module accent colors — earthy / terroir palette */
  --color-receiving:    #3F5147;   /* sage green  — raw materials */
  --color-dates:        #8B6914;   /* warm amber  — date receiving */
  --color-fermentation: #2C332F;   /* forest green — fermentation */
  --color-dist1:        #5C6E64;   /* medium sage  — distillation 1 */
  --color-dist2:        #7D4E24;   /* warm brown   — distillation 2 */
  --color-bottling:     #4A3728;   /* dark wood    — bottling */
  --color-inventory:    #3D5A52;   /* teal-sage    — inventory */
}

/* ── Dark Mode — Arava Forest Green ── */
[data-theme="dark"] {
  --bg:          #1A1E1B;
  --bg-card:     #252925;
  --bg-input:    #2C332F;
  --bg-surface:  #1E2420;
  --bg-elevated: #2C332F;

  --text:           #EFEFEC;
  --text-secondary: rgba(239, 239, 236, 0.65);
  --text-muted:     rgba(239, 239, 236, 0.35);

  /* Accent: muted sage — legible on dark forest green */
  --accent:      #8BAF96;
  --accent-hover:#A0C4AF;
  --accent-bg:   rgba(139, 175, 150, 0.12);
  --accent-bg2:  rgba(139, 175, 150, 0.20);

  --success:     #6E9A7D;
  --success-bg:  rgba(110, 154, 125, 0.15);
  --warning:     #C4A040;
  --warning-bg:  rgba(196, 160, 64, 0.15);
  --danger:      #C47070;
  --danger-bg:   rgba(196, 112, 112, 0.15);

  --border:    rgba(239, 239, 236, 0.12);
  --separator: rgba(239, 239, 236, 0.07);

  --shadow:    0 2px 12px rgba(0, 0, 0, 0.40), 0 1px 3px rgba(0, 0, 0, 0.25);
  --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.55), 0 2px 8px rgba(0, 0, 0, 0.35);
}

/* ── Reset ── */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html,
body {
  height: 100%;
  height: 100dvh;
  font-family: 'Quattrocento Sans', 'Inter', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  overflow: hidden;
  transition: background 0.25s ease, color 0.25s ease;
}

/* Thai — Trirong is a Thai-compatible serif; use it for body too */
html[lang="th"] body {
  font-family: 'Trirong', 'Noto Sans Thai', sans-serif;
}

/* Hebrew — Quattrocento Sans has no Hebrew glyphs; fall back to Inter */
html[lang="he"] body {
  font-family: 'Inter', -apple-system, sans-serif;
}

/* Serif headings — Trirong for all languages */
.header-title,
.welcome-card h2,
.login-screen h1,
.login-brand-name,
.module-card .mc-title,
.detail-card h3,
.mpd-title,
h3 {
  font-family: 'Trirong', Georgia, serif;
}

/* RTL */
html[lang="he"]        { direction: rtl; }
html[dir="rtl"] .header-left  { flex-direction: row-reverse; }
html[dir="rtl"] .header-right { flex-direction: row-reverse; }
html[dir="rtl"] .form-label .req { margin-left: 0; margin-right: 2px; }
html[dir="rtl"] .form-select,
html[dir="rtl"] .signup-role-select {
  background-position: left 14px center;
  padding-right: 14px;
  padding-left: 36px;
}
html[dir="rtl"] .login-lang-toggle { right: auto; left: 16px; }
html[dir="rtl"] .toggle-slider::before { left: auto; right: 3px; }
html[dir="rtl"] .toggle-switch input:checked + .toggle-slider::before {
  transform: translateX(-20px);
}

/* ── App Shell ── */
#app {
  height: 100%;
  height: 100dvh;
  display: flex;
  flex-direction: column;
  max-width: 600px;
  margin: 0 auto;
  position: relative;
  overflow: hidden;
  background: var(--bg);
}

.screen-content {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 20px 16px 110px;
}

/* ============================================================
   LOGIN — Arava Distillery brand treatment
   ============================================================ */
.login-screen {
  min-height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 48px 32px;
  text-align: center;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  background: var(--bg);
}

/* Brand section */
.login-brand {
  margin-bottom: 36px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.login-logo-mark {
  width: 60px;
  height: 60px;
  background: #2C332F;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
  /* Sharp — exactly like the Arava website's button corners */
  border-radius: 2px;
}

.login-brand-name {
  font-size: 30px;
  font-weight: 400;          /* Regular weight — Trirong works best at 400 */
  color: var(--text);
  letter-spacing: 8px;
  text-transform: uppercase;
  margin-bottom: 6px;
  line-height: 1;
}

.login-brand-sub {
  font-family: 'Quattrocento Sans', 'Inter', sans-serif;
  font-size: 10px;
  font-weight: 400;
  color: var(--text-secondary);
  letter-spacing: 3px;
  text-transform: uppercase;
  margin-bottom: 28px;
}

.login-brand-rule {
  width: 36px;
  height: 1px;
  background: var(--border);
}

/* Legacy login-logo for request-access icon */
.login-logo {
  width: 64px;
  height: 64px;
  background: #2C332F;
  border-radius: 2px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
  color: #EFEFEC;
}

.login-screen h1 {
  font-size: 22px;
  font-weight: 400;
  margin-bottom: 8px;
  color: var(--text);
  letter-spacing: 0.5px;
}

.login-screen p {
  color: var(--text-secondary);
  margin-bottom: 32px;
  font-size: 14px;
}

.login-form {
  width: 100%;
  max-width: 320px;
}

.login-form .field {
  margin-bottom: 12px;
}

.login-form input {
  width: 100%;
  padding: 14px 16px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 2px;          /* Sharp — Arava brand */
  color: var(--text);
  font-size: 16px;             /* 16px minimum — prevents iOS zoom */
  font-family: inherit;
  outline: none;
  transition: border-color 0.2s;
}

.login-form input:focus {
  border-color: #2C332F;
  outline: none;
}

.login-form input::placeholder { color: var(--text-muted); }

.login-btn {
  width: 100%;
  padding: 16px;
  background: #2C332F;
  color: #EFEFEC;
  border: none;
  border-radius: 2px;          /* Sharp — matches Arava website CTA buttons */
  font-size: 12px;
  font-weight: 700;
  font-family: 'Quattrocento Sans', 'Inter', sans-serif;
  letter-spacing: 2px;
  text-transform: uppercase;
  cursor: pointer;
  margin-top: 12px;
  transition: background 0.2s, transform 0.1s;
}

.login-btn:hover  { background: #1E2420; }
.login-btn:active { opacity: 0.85; transform: scale(0.98); }

.login-error {
  color: var(--danger);
  font-size: 13px;
  margin-top: 12px;
  min-height: 20px;
}

.login-success {
  color: var(--success);
  font-size: 13px;
  margin-top: 12px;
  min-height: 20px;
}

.login-switch {
  margin-top: 24px;
  font-size: 14px;
  color: var(--text-secondary);
}

.login-switch a {
  color: var(--text);
  text-decoration: underline;
  text-decoration-color: var(--border);
  text-underline-offset: 3px;
  font-weight: 400;
}

.signup-role-select {
  width: 100%;
  padding: 15px 16px;
  background: var(--bg-card);
  border: 1.5px solid var(--separator);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 16px;
  font-family: inherit;
  outline: none;
  -webkit-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238888aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  padding-right: 36px;
  transition: border-color 0.2s;
  box-shadow: var(--shadow);
}

.signup-role-select:focus { border-color: var(--accent); }
.signup-role-select option { background: var(--bg-card); color: var(--text); }

.login-lang-toggle {
  position: absolute;
  top: 16px;
  right: 16px;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-secondary);
  padding: 5px 12px;
  border-radius: 2px;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  cursor: pointer;
  font-family: 'Quattrocento Sans', 'Inter', sans-serif;
}

/* Google SSO removed */

/* ============================================================
   HEADER
   ============================================================ */
.app-header {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  padding-top: max(8px, env(safe-area-inset-top));
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  min-height: 52px;
  position: sticky;
  top: 0;
  z-index: 100;
  gap: 8px;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}

[data-theme="dark"] .app-header {
  background: rgba(37, 41, 37, 0.94); /* #252925 at 94% */
}

.header-left {
  display: flex;
  align-items: center;
  gap: 6px;
  flex: 1;
  min-width: 0;
}

.header-back {
  background: var(--accent-bg);
  border: none;
  color: var(--accent);
  cursor: pointer;
  padding: 7px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  transition: background 0.2s;
  flex-shrink: 0;
  touch-action: manipulation;
}

.header-back:active { background: var(--accent-bg2); }

.header-title {
  font-size: 14px;
  font-weight: 400;            /* Trirong regular — brand style */
  letter-spacing: 1px;
  flex: 2;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 6px;
  flex: 1;
  justify-content: flex-end;
}

.lang-btn,
.logout-btn,
.theme-btn {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 8px 14px;
  min-height: 36px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

.lang-btn:active,
.logout-btn:active,
.theme-btn:active { background: var(--border); }

.user-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--text-secondary);
  background: var(--bg-surface);
  padding: 5px 10px;
  border-radius: 20px;
  border: 1px solid var(--separator);
  font-weight: 500;
}

.role-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: var(--success);
}

.role-dot.worker { background: var(--accent); }

/* ============================================================
   BOTTOM NAV
   ============================================================ */
.bottom-nav {
  display: flex;
  background: var(--bg-card);
  border-top: 1px solid var(--separator);
  padding: 6px 0;
  padding-bottom: max(6px, env(safe-area-inset-bottom));
  position: sticky;
  bottom: 0;
  z-index: 100;
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}

[data-theme="dark"] .bottom-nav {
  background: rgba(37, 41, 37, 0.94); /* #252925 at 94% */
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 6px 4px;
  min-height: 52px;
  position: relative;
  text-decoration: none;
  color: var(--text-muted);
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 0.8px;
  text-transform: uppercase;
  cursor: pointer;
  transition: color 0.2s;
  border: none;
  background: none;
  font-family: 'Quattrocento Sans', 'Inter', sans-serif;
}

.nav-item.active { color: var(--accent); }

/* Thin blue indicator bar at top of active item */
.nav-item.active::before {
  content: '';
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 28px;
  height: 2.5px;
  background: var(--accent);
  border-radius: 0 0 3px 3px;
}

.nav-item svg { width: 22px; height: 22px; }

/* ============================================================
   DASHBOARD
   ============================================================ */
.welcome-card {
  background: #2C332F;
  border-radius: 3px;          /* Sharp — Arava brand */
  padding: 24px 20px;
  margin-bottom: 20px;
  color: #EFEFEC;
  position: relative;
  overflow: hidden;
  border-left: 3px solid #3F5147;  /* subtle sage-green accent bar */
}

/* Grain texture overlay — artisanal feel */
.welcome-card::before {
  content: '';
  position: absolute;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  opacity: 0.4;
}

.welcome-card h2 {
  color: #EFEFEC;
  font-size: 19px;
  font-weight: 400;            /* Trirong regular — artisanal */
  margin-bottom: 6px;
  letter-spacing: 0.5px;
}

.welcome-card p {
  color: rgba(239, 239, 236, 0.60);
  font-size: 12px;
  letter-spacing: 0.5px;
}

/* Today stat strip */
.today-strip {
  display: flex;
  gap: 10px;
  margin-bottom: 22px;
}

.today-chip {
  flex: 1;
  background: var(--bg-card);
  border-radius: 3px;
  padding: 14px 12px;
  text-align: center;
  border: 1px solid var(--separator);
}

.today-chip .chip-num {
  font-family: 'Trirong', Georgia, serif;
  font-size: 28px;
  font-weight: 400;            /* Trirong looks best at regular weight */
  color: var(--text);
  letter-spacing: -0.5px;
  line-height: 1;
}

.today-chip .chip-label {
  font-size: 9px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  font-weight: 700;
  margin-top: 6px;
  font-family: 'Quattrocento Sans', 'Inter', sans-serif;
}

.section-title {
  font-family: 'Quattrocento Sans', 'Inter', sans-serif;
  font-size: 9px;
  font-weight: 700;
  color: var(--text-muted);
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 2.5px;
  padding-left: 2px;
}

/* Module Grid */
.module-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 28px;
}

.module-card {
  background: var(--bg-card);
  border-radius: 3px;          /* Sharp — Arava brand */
  padding: 20px 16px 18px;
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: transform 0.12s, background 0.15s;
  position: relative;
  overflow: hidden;
  border: 1px solid var(--separator);
}

.module-card:hover  { background: var(--bg-surface); }
.module-card:active { transform: scale(0.96); }

/* Colored left accent bar — craft/artisanal style */
.module-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; bottom: 0;
  width: 3px;
}

.module-card[data-module="rawMaterials"]::before  { background: var(--color-receiving); }
.module-card[data-module="dateReceiving"]::before { background: var(--color-dates); }
.module-card[data-module="fermentation"]::before  { background: var(--color-fermentation); }
.module-card[data-module="distillation1"]::before { background: var(--color-dist1); }
.module-card[data-module="distillation2"]::before { background: var(--color-dist2); }
.module-card[data-module="bottling"]::before      { background: var(--color-bottling); }
.module-card[data-module="inventory"]::before     { background: var(--color-inventory); }

.module-card .mc-icon {
  width: 40px;
  height: 40px;
  border-radius: 2px;          /* Sharp — brand aligned */
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 14px;
  opacity: 0.85;
}

.module-card .mc-icon svg { width: 20px; height: 20px; color: #fff; }

.module-card[data-module="rawMaterials"] .mc-icon  { background: var(--color-receiving); }
.module-card[data-module="dateReceiving"] .mc-icon { background: var(--color-dates); }
.module-card[data-module="fermentation"] .mc-icon  { background: var(--color-fermentation); }
.module-card[data-module="distillation1"] .mc-icon { background: var(--color-dist1); }
.module-card[data-module="distillation2"] .mc-icon { background: var(--color-dist2); }
.module-card[data-module="bottling"] .mc-icon      { background: var(--color-bottling); }
.module-card[data-module="inventory"] .mc-icon     { background: var(--color-inventory); }

.module-card .mc-title {
  font-size: 13px;
  font-weight: 400;            /* Trirong regular — elegant */
  color: var(--text);
  line-height: 1.3;
  letter-spacing: 0.3px;
}

.module-card .mc-count {
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 3px;
  opacity: 0.75;
}

/* ============================================================
   RECENT ACTIVITY (Dashboard)
   ============================================================ */
.recent-activity-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  margin-bottom: 8px;
  cursor: pointer;
  transition: transform 0.1s;
  -webkit-tap-highlight-color: transparent;
}

.recent-activity-item:active {
  transform: scale(0.98);
}

.ra-icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.ra-icon svg {
  width: 16px;
  height: 16px;
}

.ra-content {
  flex: 1;
  min-width: 0;
}

.ra-title {
  font-size: 14px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.ra-meta {
  font-size: 12px;
  color: var(--text-secondary);
  margin-top: 2px;
}

/* ============================================================
   STATS ROW
   ============================================================ */
.stats-row {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 24px;
}

.stat-card {
  background: var(--bg-card);
  border-radius: 12px;
  padding: 16px 12px;
  text-align: center;
  border: 1px solid var(--separator);
  box-shadow: var(--shadow);
}

.stat-card .stat-num {
  font-family: 'Trirong', Georgia, serif;
  font-size: 26px;
  font-weight: 400;
  color: var(--text);
  letter-spacing: -0.5px;
  line-height: 1;
}

.stat-card .stat-label {
  font-size: 9px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  font-weight: 700;
  margin-top: 5px;
  font-family: 'Quattrocento Sans', 'Inter', sans-serif;
}

/* ============================================================
   FORMS  — iOS Grouped Style
   ============================================================ */
.form-container {
  padding: 0;
}

/* Visually group consecutive form-groups into a card */
.form-group {
  margin-bottom: 16px;
}

.form-actions {
  margin-top: 24px;
  padding-bottom: 20px;
  display: flex;
  gap: 10px;
}

.form-label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.4px;
}

.form-label .req { color: var(--danger); margin-left: 2px; }

.form-input,
.form-select,
.form-textarea {
  width: 100%;
  padding: 12px 14px;
  min-height: 48px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 16px;
  font-family: inherit;
  outline: none;
  -webkit-appearance: none;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
  border-color: var(--accent);
}

/* Inline field validation error */
.form-input.field-error,
.form-select.field-error,
.form-textarea.field-error {
  border-color: var(--danger);
}

.field-error-msg {
  font-size: 12px;
  color: var(--danger);
  margin-top: 4px;
}

/* Save button loading spinner */
.btn.is-loading {
  pointer-events: none;
  opacity: 0.7;
  position: relative;
}

.btn.is-loading::after {
  content: '';
  width: 16px;
  height: 16px;
  border: 2px solid transparent;
  border-top-color: currentColor;
  border-radius: 50%;
  animation: btnSpin 0.6s linear infinite;
  display: inline-block;
  vertical-align: middle;
  margin-inline-start: 8px;
}

@keyframes btnSpin {
  to { transform: rotate(360deg); }
}

.form-select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238888aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0 center;
  padding-right: 20px;
}

.form-textarea {
  min-height: 72px;
  resize: vertical;
  padding: 10px 0;
}

/* Toggle switch */
.toggle-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 0;
  background: transparent;
  border: none;
  border-radius: 0;
}

.toggle-row .toggle-label { font-size: 16px; color: var(--text); }

.toggle-switch {
  position: relative;
  width: 51px;
  height: 31px;
  flex-shrink: 0;
}

.toggle-switch input { opacity: 0; width: 0; height: 0; }

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(120, 120, 128, 0.25);
  border-radius: 31px;
  transition: 0.28s;
}

.toggle-slider::before {
  content: '';
  position: absolute;
  height: 27px;
  width: 27px;
  left: 2px;
  bottom: 2px;
  background: #FFFFFF;
  border-radius: 50%;
  transition: 0.28s;
  box-shadow: 0 2px 6px rgba(0,0,0,0.20);
}

.toggle-switch input:checked + .toggle-slider          { background: var(--success); }
.toggle-switch input:checked + .toggle-slider::before  { transform: translateX(20px); }

html[dir="rtl"] .toggle-switch input:checked + .toggle-slider::before {
  transform: translateX(-20px);
}

/* Time range */
.time-range-row {
  display: flex;
  gap: 8px;
  align-items: center;
}

.time-range-row input { flex: 1; }
.time-range-row span  { color: var(--text-muted); font-size: 14px; }

/* ============================================================
   BUTTONS
   ============================================================ */
.btn {
  flex: 1;
  padding: 14px;
  min-height: 48px;
  border: none;
  border-radius: 2px;          /* Sharp — Arava brand */
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  cursor: pointer;
  transition: transform 0.1s, opacity 0.2s;
  font-family: 'Quattrocento Sans', 'Inter', sans-serif;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

.btn:active { transform: scale(0.97); }

.btn-primary {
  background: var(--accent);
  color: #EFEFEC;
  box-shadow: 0 2px 8px rgba(37, 37, 37, 0.18);
}

[data-theme="dark"] .btn-primary {
  color: #1A1E1B;  /* dark text on light sage button in dark mode */
}

.btn-secondary {
  background: var(--accent-bg);
  color: var(--accent);
  border: 1px solid var(--border);
}

[data-theme="dark"] .btn-secondary {
  background: var(--accent-bg2);
  border-color: var(--separator);
}

.btn-danger {
  background: var(--danger);
  color: #fff;
  box-shadow: 0 2px 8px rgba(37, 37, 37, 0.18);
}

.btn-success {
  background: var(--success);
  color: #fff;
}

.btn:disabled { opacity: 0.4; cursor: not-allowed; }

/* ============================================================
   RECORD LIST
   ============================================================ */
.record-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.record-item {
  background: var(--bg-card);
  border-radius: var(--radius-sm);
  padding: 14px 16px;
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: transform 0.1s, box-shadow 0.1s;
  border: none;
}

.record-item:active {
  transform: scale(0.985);
  box-shadow: var(--shadow-lg);
}

.record-item .ri-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 5px;
}

.record-item .ri-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
}

.record-item .ri-date {
  font-size: 11px;
  color: var(--text-muted);
}

.record-item .ri-details {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.5;
}

.record-item .ri-badge {
  display: inline-flex;
  align-items: center;
  padding: 3px 9px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 600;
}

.ri-badge.approved    { background: var(--success-bg); color: var(--success); }
.ri-badge.not-approved{ background: var(--danger-bg);  color: var(--danger); }
.ri-badge.pending     { background: var(--warning-bg); color: var(--warning); }

/* ============================================================
   INVENTORY
   ============================================================ */
.inv-section { margin-bottom: 20px; }

.inv-section h3 {
  font-size: 13px;
  font-weight: 700;
  color: var(--text-muted);
  margin-bottom: 10px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.inv-table {
  width: 100%;
  border-collapse: collapse;
  background: var(--bg-card);
  border-radius: var(--radius-sm);
  overflow: hidden;
  box-shadow: var(--shadow);
}

.inv-table th,
.inv-table td {
  padding: 12px 14px;
  text-align: left;
  font-size: 14px;
  border-bottom: 1px solid var(--separator);
}

.inv-table th {
  color: var(--text-muted);
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  background: var(--bg-surface);
}

.inv-table td { color: var(--text); }
.inv-table tr:last-child td { border-bottom: none; }

.stock-positive { color: var(--success); font-weight: 600; }
.stock-negative { color: var(--danger);  font-weight: 600; }
.stock-zero     { color: var(--text-muted); }

.inv-pending-banner {
  display: flex;
  align-items: center;
  background: var(--warning-bg);
  border: 1px solid rgba(255, 149, 0, 0.25);
  border-radius: var(--radius-sm);
  padding: 10px 14px;
  font-size: 13px;
  color: var(--warning);
  margin-bottom: 14px;
  font-weight: 500;
}

/* ============================================================
   TOAST
   ============================================================ */
.toast {
  position: fixed;
  bottom: 90px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: rgba(0, 0, 0, 0.82);
  color: #fff;
  padding: 12px 22px;
  border-radius: 24px;
  font-size: 14px;
  font-weight: 500;
  z-index: 2000;
  opacity: 0;
  transition: all 0.28s cubic-bezier(0.34, 1.56, 0.64, 1);
  white-space: nowrap;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

[data-theme="dark"] .toast {
  background: rgba(58, 58, 60, 0.95);
}

.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

/* ============================================================
   SYNC INDICATOR
   ============================================================ */
.sync-indicator {
  position: fixed;
  top: 12px;
  right: 12px;
  background: rgba(0, 0, 0, 0.72);
  color: #fff;
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 500;
  z-index: 1999;
  display: flex;
  align-items: center;
  gap: 6px;
  opacity: 1;
  transition: opacity 0.6s ease;
  pointer-events: none;
  backdrop-filter: blur(6px);
}

[dir="rtl"] .sync-indicator {
  right: auto;
  left: 12px;
}

.sync-indicator.sync-fade {
  opacity: 0;
}

.sync-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  display: inline-block;
  flex-shrink: 0;
}

.sync-dot.pulse {
  background: #60a5fa;
  animation: syncPulse 1s ease-in-out infinite;
}

.sync-dot.green { background: #22c55e; }
.sync-dot.red   { background: #ef4444; }

@keyframes syncPulse {
  0%, 100% { opacity: 1; }
  50%       { opacity: 0.25; }
}

/* ============================================================
   PERMISSION OVERLAY & EMPTY STATE
   ============================================================ */
.perm-overlay {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 24px;
  text-align: center;
  color: var(--text-muted);
}

.perm-overlay svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.4; }
.perm-overlay p   { font-size: 15px; }

.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 56px 24px;
  text-align: center;
  color: var(--text-muted);
}

.empty-state svg {
  width: 48px;
  height: 48px;
  margin-bottom: 12px;
  opacity: 0.4;
}

.empty-state p {
  font-size: 14px;
}

/* ============================================================
   RESPONSIVE — WIDER SCREENS
   ============================================================ */

/* Lock the app to a phone-width column on all non-mobile screens */
@media (min-width: 481px) {
  #app {
    border-left: 1px solid var(--border);
    border-right: 1px solid var(--border);
    box-shadow: 0 0 60px rgba(0, 0, 0, 0.4);
    max-width: 480px;
  }

  body {
    display: flex;
    align-items: flex-start;
    justify-content: center;
  }
}

/* Tablets and small desktops */
@media (min-width: 768px) {
  .module-grid {
    grid-template-columns: repeat(3, 1fr);
  }

  .stats-row {
    grid-template-columns: repeat(3, 1fr);
  }

  .login-form {
    max-width: 360px;
  }

  .form-actions {
    max-width: 380px;
    margin-left: auto;
    margin-right: auto;
  }
}

/* Large desktops — vertically center the phone frame */
@media (min-width: 1024px) {
  body {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #app {
    height: 90vh;
    max-height: 900px;
    border-radius: 24px;
    overflow: hidden;
    border: 1px solid var(--border);
  }

  .bottom-nav {
    border-radius: 0 0 24px 24px;
  }
}

/* ============================================================
   SIGNATURE PAD
   ============================================================ */
.sig-pad-wrapper {
  border: 1.5px solid var(--separator);
  border-radius: var(--radius-sm);
  overflow: hidden;
  position: relative;
  background: var(--bg-card);
  box-shadow: var(--shadow);
}

.sig-pad-wrapper canvas {
  width: 100%;
  height: 120px;
  display: block;
  touch-action: none;
}

.sig-clear {
  position: absolute;
  top: 8px; right: 8px;
  background: var(--bg-surface);
  border: 1px solid var(--separator);
  color: var(--text-secondary);
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
}

/* ============================================================
   FAB
   ============================================================ */
.fab-add {
  position: absolute;
  bottom: 84px;
  right: 18px;
  width: 54px;
  height: 54px;
  border-radius: 8px;           /* sharp — brand aligned */
  background: var(--accent);
  color: #EFEFEC;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 16px rgba(37, 37, 37, 0.22);
  z-index: 50;
  transition: transform 0.15s, box-shadow 0.15s;
}

.fab-add:active {
  transform: scale(0.90);
  box-shadow: 0 2px 8px rgba(37, 37, 37, 0.18);
}

.fab-add svg { width: 24px; height: 24px; }

/* ============================================================
   TAB BAR
   ============================================================ */
.tab-bar {
  display: flex;
  gap: 4px;
  margin-bottom: 18px;
  background: var(--bg-card);
  border-radius: var(--radius-sm);
  padding: 4px;
  box-shadow: var(--shadow);
}

.tab-btn {
  flex: 1;
  padding: 9px 4px;
  border: none;
  background: transparent;
  color: var(--text-muted);
  font-size: 12px;
  font-weight: 600;
  border-radius: var(--radius-xs);
  cursor: pointer;
  transition: all 0.2s;
  font-family: inherit;
  letter-spacing: -0.1px;
}

.tab-btn.active {
  background: var(--accent);
  color: #EFEFEC;
  box-shadow: 0 2px 6px rgba(37, 37, 37, 0.18);
}

[data-theme="dark"] .tab-btn.active {
  color: #1A1E1B;
}

/* ============================================================
   DETAIL VIEW
   ============================================================ */
.detail-card {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 0 16px;
  margin-bottom: 16px;
  box-shadow: var(--shadow);
  overflow: hidden;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 13px 0;
  border-bottom: 1px solid var(--separator);
  font-size: 14px;
}

.detail-row:last-child { border-bottom: none; }
.detail-row .dl { color: var(--text-secondary); font-weight: 500; flex: 1; }
.detail-row .dv {
  color: var(--text);
  font-weight: 600;
  text-align: right;
  max-width: 58%;
}

.detail-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 16px;
}

.detail-card h3 {
  font-size: 14px;
  margin-bottom: 12px;
  color: var(--text);
}

/* ============================================================
   ANIMATIONS
   ============================================================ */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(8px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* iOS-style push/pop screen transitions */
@keyframes slideInFromRight {
  from { transform: translateX(30%); opacity: 0; }
  to   { transform: translateX(0);   opacity: 1; }
}

@keyframes slideInFromLeft {
  from { transform: translateX(-30%); opacity: 0; }
  to   { transform: translateX(0);    opacity: 1; }
}

@keyframes fadeInUp {
  from { transform: translateY(12px); opacity: 0; }
  to   { transform: translateY(0);    opacity: 1; }
}

.screen-content>* {
  animation: fadeInUp 0.22s ease-out forwards;
}

.screen-content.nav-forward>* {
  animation: slideInFromRight 0.25s ease-out forwards;
}

.screen-content.nav-back>* {
  animation: slideInFromLeft 0.25s ease-out forwards;
}

/* (duplicate stat-card definitions removed — see STATS ROW section above) */

/* ============================================================
   REVISED RECORD ITEM
   ============================================================ */
.record-item.user-item .ri-details,
.record-item.inv-ver-item .ri-details {
  font-size: 11px;
  line-height: 1.4;
}
/* ============================================================
   MANAGER PASSWORD MODAL
   ============================================================ */
.manager-pwd-modal {
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
}

.manager-pwd-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.45);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

.manager-pwd-dialog {
  position: relative;
  background: var(--bg-card);
  border-radius: calc(var(--radius) + 4px);
  padding: 28px 24px;
  width: 100%;
  max-width: 340px;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.22s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.mpd-title {
  display: flex;
  align-items: center;
  font-size: 17px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 8px;
}

.mpd-subtitle {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 20px;
  line-height: 1.5;
}

.mpd-input   { margin-bottom: 8px; }

.mpd-error {
  min-height: 18px;
  font-size: 12px;
  color: var(--danger);
  margin-bottom: 14px;
}

.mpd-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}

/* ============================================================
   CUSTOM SELECT OPTION FORM
   ============================================================ */
.custom-option-form {
  margin-top: 10px;
  padding: 14px;
  background: var(--bg-surface);
  border: 1.5px dashed var(--border);
  border-radius: var(--radius-sm);
  animation: fadeIn 0.15s ease;
}

.custom-option-input   { margin-bottom: 10px; }

.custom-option-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

/* ============================================================
   BACKOFFICE
   ============================================================ */
.role-pill {
  display: inline-block;
  padding: 3px 9px;
  border-radius: 20px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.4px;
}

.role-pill-admin   { background: var(--accent-bg);  color: var(--accent); }
.role-pill-manager { background: rgba(90, 200, 250, 0.15); color: #0099CC; }
.role-pill-worker  { background: var(--success-bg); color: var(--success); }

[data-theme="dark"] .role-pill-manager { color: #5AC8FA; }

.backoffice-subtitle {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 18px;
  line-height: 1.5;
}

.permissions-legend {
  background: var(--bg-card);
  border-radius: var(--radius-sm);
  padding: 14px 16px;
  margin-bottom: 6px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  box-shadow: var(--shadow);
}

.perm-legend-row {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  font-size: 12px;
  color: var(--text-secondary);
  line-height: 1.5;
}

.perm-legend-row .role-pill {
  flex-shrink: 0;
  margin-top: 1px;
}

/* ============================================================
   SPIRIT PIPELINE SCREEN
   ============================================================ */
.spirit-pipeline {
  display: flex;
  flex-direction: column;
  gap: 0;
  margin-top: 12px;
}

.spirit-stage {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 0;
}

.spirit-stage-final {
  border-color: var(--success);
}

.spirit-stage-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 700;
  font-size: 14px;
  color: var(--text);
  margin-bottom: 12px;
}

.spirit-stage-stats {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.spirit-stat {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
}

.spirit-stat-available {
  border-top: 1px solid var(--border);
  padding-top: 6px;
  margin-top: 2px;
}

.spirit-stat-label {
  color: var(--text-secondary);
}

.spirit-stat-val {
  font-weight: 700;
  font-size: 16px;
  color: var(--text);
}

.spirit-stat-in {
  color: var(--success);
}

.spirit-stat-out {
  color: var(--danger);
  font-size: 13px;
}

.spirit-arrow {
  display: flex;
  justify-content: center;
  padding: 4px 0;
  color: var(--text-muted, var(--text-secondary));
  opacity: 0.5;
}

.spirit-count-note {
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 10px;
  opacity: 0.7;
}

.spirit-hint {
  margin-top: 16px;
  padding: 10px 14px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  font-size: 12px;
  color: var(--text-secondary);
  line-height: 1.5;
}


/* ============================================================
   EXPORT BUTTON
   ============================================================ */
.export-row {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 14px;
}

/* ============================================================
   NOTIFICATION BELL (pending access requests)
   ============================================================ */
.notif-btn {
  position: relative;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--accent);
  padding: 6px;
  display: flex;
  align-items: center;
  flex-shrink: 0;
}

.notif-badge {
  position: absolute;
  top: 0;
  right: 0;
  background: var(--danger);
  color: #fff;
  font-size: 10px;
  font-weight: 700;
  min-width: 16px;
  height: 16px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 4px;
}

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Trirong:ital,wght@0,400;0,600;0,700;1,400&family=Quattrocento+Sans:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600;700&family=Noto+Sans+Thai:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script>
// ============================================================
// firebase.js — Firebase / Firestore Database Layer
// ============================================================
// SETUP: Replace the config below with your Firebase project config.
// Get it from: Firebase Console → Project Settings → Your Apps → SDK setup
// ============================================================

const FIREBASE_CONFIG = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

// ---- Feature flag: set to true after filling in config above ----
const FIREBASE_ENABLED = false;

// ============================================================
// Internal state
// ============================================================
let _db = null;
let _firebaseReady = false;

// ---- Real-time listeners registry ----
const _listeners = {};

function isFirebaseReady() {
  return _firebaseReady && _db !== null;
}

// ============================================================
// Initialization — loads Firebase SDK on-demand (no extra KB when disabled)
// ============================================================
function initFirebase() {
  if (!FIREBASE_ENABLED) return; // SDK never loaded, zero cost

  function loadScript(src) {
    return new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = src;
      s.onload = resolve;
      s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  const BASE = 'https://www.gstatic.com/firebasejs/9.23.0';
  Promise.all([
    loadScript(BASE + '/firebase-app-compat.js'),
    loadScript(BASE + '/firebase-firestore-compat.js'),
  ]).then(() => {
    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(FIREBASE_CONFIG);
      }
      _db = firebase.firestore();
      _firebaseReady = true;
      console.log('[Firebase] Firestore connected');
    } catch (e) {
      console.warn('[Firebase] Init failed, using localStorage fallback:', e.message);
    }
  }).catch(e => {
    console.warn('[Firebase] SDK load failed, using localStorage fallback:', e.message);
  });
}

// ============================================================
// Generic CRUD — mirrors the localStorage data.js API
// ============================================================

/**
 * Get all documents from a Firestore collection (returns Promise).
 */
async function fbGetAll(collectionName) {
  if (!isFirebaseReady()) return null;
  try {
    const snap = await _db.collection(collectionName)
      .orderBy('createdAt', 'desc')
      .get();
    return snap.docs.map(d => ({ ...d.data(), _fbId: d.id }));
  } catch (e) {
    console.warn('[Firebase] fbGetAll error:', e.message);
    return null;
  }
}

/**
 * Add a document to a Firestore collection.
 */
async function fbAdd(collectionName, record) {
  if (!isFirebaseReady()) return null;
  try {
    const docRef = await _db.collection(collectionName).add(record);
    return { ...record, _fbId: docRef.id };
  } catch (e) {
    console.warn('[Firebase] fbAdd error:', e.message);
    return null;
  }
}

/**
 * Update a document in Firestore by local `id` field.
 */
async function fbUpdate(collectionName, localId, updates) {
  if (!isFirebaseReady()) return null;
  try {
    // find by localId field
    const snap = await _db.collection(collectionName)
      .where('id', '==', localId).limit(1).get();
    if (snap.empty) return null;
    await snap.docs[0].ref.update({ ...updates, updatedAt: new Date().toISOString() });
    return true;
  } catch (e) {
    console.warn('[Firebase] fbUpdate error:', e.message);
    return null;
  }
}

/**
 * Delete a document from Firestore by local `id` field.
 */
async function fbDelete(collectionName, localId) {
  if (!isFirebaseReady()) return null;
  try {
    const snap = await _db.collection(collectionName)
      .where('id', '==', localId).limit(1).get();
    if (snap.empty) return null;
    await snap.docs[0].ref.delete();
    return true;
  } catch (e) {
    console.warn('[Firebase] fbDelete error:', e.message);
    return null;
  }
}

/**
 * Subscribe to real-time updates for a collection.
 * callback(records) is called every time data changes.
 * Returns an unsubscribe function.
 */
function fbSubscribe(collectionName, callback) {
  if (!isFirebaseReady()) return () => {};
  try {
    const unsub = _db.collection(collectionName)
      .orderBy('createdAt', 'desc')
      .onSnapshot(snap => {
        const records = snap.docs.map(d => ({ ...d.data(), _fbId: d.id }));
        callback(records);
      }, err => {
        console.warn('[Firebase] onSnapshot error:', err.message);
      });
    return unsub;
  } catch (e) {
    console.warn('[Firebase] fbSubscribe error:', e.message);
    return () => {};
  }
}

// ============================================================
// Custom Options (shared dropdown choices)
// ============================================================
async function fbGetCustomOptions(fieldKey) {
  if (!isFirebaseReady()) {
    return JSON.parse(localStorage.getItem('factory_customOptions_' + fieldKey) || '[]');
  }
  try {
    const snap = await _db.collection('factory_customOptions')
      .where('fieldKey', '==', fieldKey).get();
    return snap.docs.map(d => d.data().value);
  } catch (e) {
    return JSON.parse(localStorage.getItem('factory_customOptions_' + fieldKey) || '[]');
  }
}

async function fbAddCustomOption(fieldKey, value) {
  // Always save to localStorage as backup
  const local = JSON.parse(localStorage.getItem('factory_customOptions_' + fieldKey) || '[]');
  if (!local.includes(value)) {
    local.push(value);
    localStorage.setItem('factory_customOptions_' + fieldKey, JSON.stringify(local));
  }

  if (!isFirebaseReady()) return;
  try {
    // Check for duplicate
    const snap = await _db.collection('factory_customOptions')
      .where('fieldKey', '==', fieldKey)
      .where('value', '==', value)
      .get();
    if (snap.empty) {
      await _db.collection('factory_customOptions').add({
        fieldKey,
        value,
        createdAt: new Date().toISOString()
      });
    }
  } catch (e) {
    console.warn('[Firebase] fbAddCustomOption error:', e.message);
  }
}

// ============================================================
// Users
// ============================================================
async function fbGetUsers() {
  if (!isFirebaseReady()) return null;
  try {
    const snap = await _db.collection('factory_users').get();
    return snap.docs.map(d => ({ ...d.data(), _fbId: d.id }));
  } catch (e) {
    return null;
  }
}

async function fbSaveUser(user) {
  if (!isFirebaseReady()) return null;
  try {
    // Upsert by username
    const snap = await _db.collection('factory_users')
      .where('username', '==', user.username).limit(1).get();
    if (snap.empty) {
      await _db.collection('factory_users').add(user);
    } else {
      await snap.docs[0].ref.update(user);
    }
    return true;
  } catch (e) {
    console.warn('[Firebase] fbSaveUser error:', e.message);
    return null;
  }
}

async function fbDeleteUser(username) {
  if (!isFirebaseReady()) return null;
  try {
    const snap = await _db.collection('factory_users')
      .where('username', '==', username).limit(1).get();
    if (!snap.empty) {
      await snap.docs[0].ref.delete();
      return true;
    }
    return null;
  } catch (e) {
    console.warn('[Firebase] fbDeleteUser error:', e.message);
    return null;
  }
}

// Google SSO removed — login is handled via email + password only.

// ============================================================
// Sync: push all localStorage data to Firestore (one-time migration)
// ============================================================
async function migrateLocalStorageToFirebase() {
  if (!isFirebaseReady()) return;
  const keys = [
    'factory_rawMaterials', 'factory_dateReceiving', 'factory_fermentation',
    'factory_distillation1', 'factory_distillation2', 'factory_bottling',
    'factory_inventoryVersions'
  ];
  for (const key of keys) {
    const local = JSON.parse(localStorage.getItem(key) || '[]');
    for (const record of local) {
      try {
        const existing = await _db.collection(key)
          .where('id', '==', record.id).get();
        if (existing.empty) {
          await _db.collection(key).add(record);
        }
      } catch (e) {
        // skip
      }
    }
  }
  console.log('[Firebase] Migration complete');
}

    </script>
    <script>
// ============================================================
// i18n.js — English / Hebrew translation system
// ============================================================
const I18N = {
  en: {
    // ---------- Global ----------
    appName: "Factory Control",
    langToggle: "עב",
    logout: "Logout",
    save: "Save",
    cancel: "Cancel",
    delete: "Delete",
    edit: "Edit",
    back: "Back",
    submit: "Submit",
    confirm: "Confirm",
    yes: "Yes",
    no: "No",
    done: "Done",
    notDone: "Not Done",
    notes: "Notes",
    date: "Date",
    today: "Today",
    search: "Search…",
    noData: "No records yet",
    addNew: "Add New",
    history: "History",
    required: "Required",
    optional: "Optional",
    saved: "Saved successfully!",
    exportCSV: "Export CSV",
    dashboard: "Dashboard",
    settings: "Settings",
    recentEntries: "Recent Entries",
    viewAll: "View All",
    totalRecords: "Total Records",
    normal: "Normal",
    abnormal: "Abnormal",
    approved: "Approved",
    notApproved: "Not Approved",
    selectOne: "-- Select --",
    addNote: "Add a note…",
    loginTitle: "Factory Control",
    loginSubtitle: "Alcohol Production Documentation",
    username: "Username",
    password: "Password",
    login: "Log In",
    loginError: "Invalid email or password",
    emailAddress: "Email Address",
    requestAccess: "Request Access",
    requestAccessTitle: "Request Access",
    requestAccessSubtitle: "Enter your details and an admin will approve your account",
    requestAccessBtn: "Send Request",
    requestSent: "Request sent! You will be notified when your account is approved.",
    requestError_fillAll: "Please enter your name and email",
    requestError_alreadyPending: "A request for this email is already pending",
    requestError_emailExists: "This email already has an account",
    alreadyHaveAccount: "Already have an account?",
    dontHaveAccount: "Don't have an account?",
    pendingRequestsTitle: "Access Requests",
    pendingRequestsEmpty: "No pending access requests",
    approveUser: "Approve",
    denyUser: "Deny",
    setPassword: "Set Password",
    selectRole: "Select Role",
    role_manager: "Manager",
    role_worker: "Worker",
    role_admin: "Administrator",
    requestedAt: "Requested",
    fullName: "Full Name",
    signUpError_userExists: "Username already taken",
    signUpError_fillAll: "Please fill in all fields",
    welcome: "Welcome",
    quickActions: "Quick Actions",
    productionOverview: "Production Overview",
    todayActivity: "Today's Activity",
    lastActivity: "Last Activity",
    releaseVersion: "Release Version",
    inventoryHistory: "Inventory Versions",
    gapAnalysis: "Gap Analysis",
    addNewSupplier: "Add New Supplier…",
    supplierName: "Supplier Name",
    emailInvite: "Send Email Invitation",
    permissionsRules: "Permissions & Rules",

    // ---------- Backoffice ----------
    backoffice: "Backoffice",
    userManagement: "User Management",
    manageUsers: "Manage Users",
    addUser: "Add User",
    editUser: "Edit User",
    deleteUser: "Delete User",
    userList: "User List",
    permissions: "Permissions",
    active: "Active",
    inactive: "Inactive",
    lastLogin: "Last Login",
    createdAt: "Created At",
    actions: "Actions",
    email: "Email",
    phone: "Phone",
    status: "Status",

    // ---------- Nav ----------
    nav_dashboard: "Dashboard",
    nav_receiving: "Receiving",
    nav_production: "Production",
    nav_spiritStock: "Spirit",
    nav_bottling: "Bottling",
    nav_inventory: "Inventory",
    nav_backoffice: "Backoffice",

    // ---------- Module Titles ----------
    mod_rawMaterials: "Raw Material Receiving",
    mod_dateReceiving: "Date Receiving",
    mod_fermentation: "Fermentation",
    mod_distillation1: "Distillation 1",
    mod_distillation2: "Distillation 2",
    mod_bottling: "Bottling",
    mod_inventory: "Inventory",
    mod_bottleInventory: "Bottle Inventory",
    mod_rawInventory: "Raw Material Inventory",
    mod_spiritStock: "Spirit Pipeline",

    // ---------- Spirit Pipeline ----------
    spirit_pipeline: "Distillation Pipeline",
    spirit_d1Label: "First Distillation (D1)",
    spirit_d2Label: "Second Distillation (D2)",
    spirit_produced: "Produced (L)",
    spirit_consumed: "Consumed (L)",
    spirit_available: "Available (L)",
    spirit_readyToBottle: "Ready to Bottle",
    spirit_noData: "No distillation records yet.",

    // Settings
    settings: "Settings",
    dataExport: "Data Backup",
    exportAllData: "Export Full Database (CSV)",
    confirmExport: "Download full database backup?",

    // ---------- Google Sheets ----------
    sheetsIntegration: "Google Sheets Integration",
    viewInventorySheet: "View Inventory Sheet",
    sheetsUrl: "Apps Script Web App URL",
    sheetsUrlPlaceholder: "https://script.google.com/macros/s/...",
    sheetsUrlHint: "Paste your Google Apps Script URL to sync all modules to Google Sheets automatically.",
    sheetsSave: "Save URL",
    sheetsSaved: "Google Sheets URL saved ✓",
    sheetsTestConnection: "Test Connection",
    sheetsSyncAll: "Sync All Now",
    syncInProgress: "Syncing...",
    syncSuccess: "Synced ✓",
    syncFailed: "Sync failed — check connection",

    // ---------- Raw Materials ----------
    rm_supplier: "Supplier",
    rm_receiveDate: "Receiving Date",
    rm_category: "Category",
    rm_item: "Specific Item",
    rm_weight: "Weight / Quantity",
    rm_unit: "Unit",
    rm_expiry: "Expiry Date",
    rm_tithing: "Tithing Done",
    rm_healthCert: "Health Ministry Cert.",
    rm_kosher: "Kosher Certificate",
    rm_cat_spices: "Spices",
    rm_cat_labels: "Labels",
    rm_cat_packaging: "Packaging",

    // ---------- Date Receiving ----------
    dr_supplier: "Supplier",
    dr_receiveDate: "Receiving Date",
    dr_weight: "Weight (kg)",
    dr_tithing: "Tithing",
    dr_expiryPeriod: "Expiry Period",
    dr_expiryPeriod_1year: "1 Year",
    dr_expiryPeriod_custom: "Custom",
    dr_qtyInDate: "Quantity in Date",

    // ---------- Fermentation ----------
    fm_date: "Date",
    fm_tankSize: "Tank Size (L)",
    fm_datesCrates: "Number of Crates (1 crate = 20 kg)",
    fm_temperature: "Temperature (°C)",
    fm_sugar: "Sugar Content",
    fm_ph: "pH",
    fm_sentToDistillation: "Sent to Distillation",

    // ---------- Distillation 1 ----------
    d1_date: "Date",
    d1_type: "Type",
    d1_stillName: "Still Name",
    d1_fermDate: "Fermentation Date",
    d1_distQty: "Distillation Qty (L)",
    d1_initAlcohol: "Initial Alcohol %",
    d1_initTemp: "Initial Temp (°C)",
    d1_finalAlcohol: "Final Alcohol %",
    d1_temp: "Temperature (°C)",
    d1_timeRange: "Time Range",
    d1_distilledQty: "Distilled Qty (L)",
    d1_type_dist1: "Distillation 1",
    d1_type_tailsArak: "Tails - Arak",
    d1_type_tailsGin: "Tails - Gin",
    d1_type_tailsEDV: "Tails - EDV",
    d1_type_cleaning: "Cleaning Distillation",
    d1_still_amiti: "Amiti",
    d1_still_aladdin: "Aladdin",

    // ---------- Distillation 2 ----------
    d2_date: "Date",
    d2_productType: "Product Type",
    d2_d1Dates: "Distillation 1 Dates",
    d2_batchNumber: "Batch Number",
    d2_initAlcohol: "Initial Alcohol %",
    d2_headSep: "Head Separation (5L)",
    d2_tailAlcohol: "Tail Separation %",
    d2_temp: "Temperature (°C)",
    d2_timeRange: "Time Range",
    d2_quantity: "Quantity (L)",
    d2_d1InputQty: "D1 Spirit Consumed (L)",

    // ---------- Bottling ----------
    bt_drinkType: "Drink Type",
    bt_bottlingDate: "Bottling Date",
    bt_batchNumber: "Batch Number",
    bt_barrelNumber: "Barrel Number",
    bt_d2Date: "Distillation 2 Date",
    bt_alcohol: "Alcohol %",
    bt_filtered: "Filtered",
    bt_color: "Color",
    bt_taste: "Taste & Smell",
    bt_contaminants: "Contaminant-Free",
    bt_bottleCount: "Bottle Count",
    bt_d2InputQty: "D2 Spirit Consumed (L)",
    bt_decision: "Decision",
    bt_qaSignature: "QA Signature",
    bt_pendingApproval: "Pending Approval",
    bt_approve: "Approve",

    // ---------- Drink Types ----------
    drink_arak: "Arak",
    drink_gin: "Gin",
    drink_edv: "EDV",
    drink_licorice: "Licorice",
    drink_brandyVS: "Brandy VS",
    drink_brandyVSOP: "Brandy VSOP",
    drink_brandyMed: "Mediterranean Brandy",

    // ---------- Inventory ----------
    inv_drinkType: "Drink Type",
    inv_warehouseQty: "Warehouse Qty",
    inv_item: "Item",
    inv_component: "Component",
    inv_unit: "Unit",
    inv_stock: "Stock",
    inv_bottles: "Bottles & Corks",
    inv_labels: "Labels",
    inv_spices: "Spices",
    inv_dates: "Dates Available (kg)",
    inv_datesUsed: "Dates in Fermentation (kg)",
    inv_cartons: "Cartons",

    // ---------- Permissions ----------
    perm_denied: "You don't have permission to access this feature",
    perm_managerOnly: "Manager access only",
    perm_deleteConfirm: "Are you sure you want to delete this record?",

    // ---------- Misc UI ----------
    modulesLabel: "Modules",
    pendingApprovals: "Pending",
    recentActivity: "Recent Activity",
    tapPlusToAdd: "Tap + to add your first record",
    clearSignature: "Clear",
    keepCurrentPassword: "Leave blank to keep current",
    sessionExpired: "Session expired. Please log in.",
    versionLabel: "Version",
    noGaps: "No gaps",
    gapsLabel: "Gaps",
    nameEnglish: "Full Name (English/Thai)",
    nameHebrew: "Full Name (Hebrew)",

    // ---------- Suppliers ----------
    sup_tamartushka: "Tamartushka",
    sup_nichuchot: "Nichuchot Argaman",
    sup_iherb: "I-HERB",
    sup_shlr: "SH.L.R",
    sup_pcsi: "PCSI",
    sup_yakev: "Yakev HaEla",
    sup_selfHarvest: "Self-harvest",
    sup_gamliel: "Gamliel",
    sup_lara: "Lara",
    sup_other: "Other",

    // ---------- Delete modal ----------
    deleteConfirmTitle: "Manager Authorization Required",
    deleteConfirmSubtitle: "Enter a manager password to confirm deletion.",
    managerPasswordPlaceholder: "Manager password",
    deleteWrongPassword: "Incorrect manager password",
    cannotDeleteAdmin: "Cannot delete the main admin account",
    cannotDeleteSelf: "Cannot delete your own account",

    // ---------- Custom options ----------
    addNewOption: "+ Add new option…",
    newOptionPlaceholder: "Type new option…",
    optionAdded: "Option added successfully",

    // ---------- Inventory buffer ----------
    pendingChanges: "{n} pending update(s) — will appear in < 1 min",

    // ---------- Backoffice ----------
    backofficeSubtitle: "Manage team members, roles, and access levels.",
    permAdmin: "Super admin — all permissions including approving bottling",
    permManager: "Full access — can view all pages, delete records, and manage users",
    permWorker: "Limited access — can add records, cannot delete or access management",
  },

  he: {
    // ---------- Global ----------
    appName: "בקרת מפעל",
    langToggle: "ไทย",
    logout: "התנתק",
    save: "שמור",
    cancel: "בטל",
    delete: "מחק",
    edit: "ערוך",
    back: "חזור",
    submit: "שלח",
    confirm: "אשר",
    yes: "כן",
    no: "לא",
    done: "בוצע",
    notDone: "לא בוצע",
    notes: "הערות",
    date: "תאריך",
    today: "היום",
    search: "חיפוש…",
    noData: "אין רשומות עדיין",
    addNew: "הוסף חדש",
    history: "היסטוריה",
    required: "חובה",
    optional: "אופציונלי",
    saved: "נשמר בהצלחה!",
    exportCSV: "ייצא CSV",
    dashboard: "לוח בקרה",
    settings: "הגדרות",
    recentEntries: "רשומות אחרונות",
    viewAll: "הצג הכל",
    totalRecords: "סה\"כ רשומות",
    normal: "תקין",
    abnormal: "לא תקין",
    approved: "מאושר",
    notApproved: "לא מאושר",
    selectOne: "-- בחר --",
    addNote: "הוסף הערה…",
    loginTitle: "בקרת מפעל",
    loginSubtitle: "תיעוד ייצור אלכוהול",
    username: "שם משתמש",
    password: "סיסמה",
    login: "התחבר",
    loginError: "אימייל או סיסמה שגויים",
    emailAddress: "כתובת אימייל",
    requestAccess: "בקש גישה",
    requestAccessTitle: "בקשת גישה",
    requestAccessSubtitle: "הזן את פרטיך ומנהל יאשר את חשבונך",
    requestAccessBtn: "שלח בקשה",
    requestSent: "הבקשה נשלחה! תקבל הודעה כאשר חשבונך יאושר.",
    requestError_fillAll: "נא למלא שם ואימייל",
    requestError_alreadyPending: "בקשה עבור אימייל זה כבר ממתינה",
    requestError_emailExists: "לאימייל זה כבר קיים חשבון",
    alreadyHaveAccount: "כבר יש לך חשבון?",
    dontHaveAccount: "אין לך חשבון?",
    pendingRequestsTitle: "בקשות גישה",
    pendingRequestsEmpty: "אין בקשות גישה ממתינות",
    approveUser: "אשר",
    denyUser: "דחה",
    setPassword: "הגדר סיסמה",
    selectRole: "בחר תפקיד",
    role_manager: "מנהל",
    role_worker: "עובד",
    role_admin: "מנהל מערכת",
    requestedAt: "נשלח",
    fullName: "שם מלא",
    signUpError_userExists: "שם המשתמש כבר תפוס",
    signUpError_fillAll: "נא למלא את כל השדות",
    welcome: "ברוך הבא",
    quickActions: "פעולות מהירות",
    productionOverview: "סקירת ייצור",
    todayActivity: "פעילות היום",
    lastActivity: "פעילות אחרונה",
    releaseVersion: "שחרור גרסה",
    inventoryHistory: "גרסאות מלאי",
    gapAnalysis: "ניתוח פערים",
    addNewSupplier: "הוסף ספק חדש…",
    supplierName: "שם הספק",
    emailInvite: "שלח הזמנה בדוא\"ל",
    permissionsRules: "הרשאות וכללים",

    // ---------- Backoffice ----------
    settings: "הגדרות",
    dataExport: "גיבוי נתונים",
    exportAllData: "ייצא מסד נתונים מלא (CSV)",
    confirmExport: "להוריד גיבוי מלא?",

    // ---------- Google Sheets ----------
    sheetsIntegration: "סנכרון Google Sheets",
    viewInventorySheet: "צפה בגיליון המלאי",
    sheetsUrl: "כתובת Web App של Apps Script",
    sheetsUrlPlaceholder: "https://script.google.com/macros/s/...",
    sheetsUrlHint: "הדבק את כתובת ה-URL כדי לסנכרן את כל הנתונים ל-Google Sheets באופן אוטומטי.",
    sheetsSave: "שמור כתובת",
    sheetsSaved: "כתובת Google Sheets נשמרה ✓",
    sheetsTestConnection: "בדוק חיבור",
    sheetsSyncAll: "סנכרן הכל עכשיו",
    syncInProgress: "מסנכרן...",
    syncSuccess: "סונכרן ✓",
    syncFailed: "הסנכרון נכשל — בדוק חיבור",

    backoffice: "ניהול מערכת",
    userManagement: "ניהול משתמשים",
    manageUsers: "נהל משתמשים",
    addUser: "הוסף משתמש",
    editUser: "ערוך משתמש",
    deleteUser: "מחק משתמש",
    userList: "רשימת משתמשים",
    permissions: "הרשאות",
    active: "פעיל",
    inactive: "לא פעיל",
    lastLogin: "התחברות אחרונה",
    createdAt: "נוצר בתאריך",
    actions: "פעולות",
    email: "דוא\"ל",
    phone: "טלפון",
    status: "סטטוס",

    // ---------- Nav ----------
    nav_dashboard: "לוח בקרה",
    nav_receiving: "קבלה",
    nav_production: "ייצור",
    nav_spiritStock: "אלכוהול",
    nav_bottling: "ביקבוק",
    nav_inventory: "מלאי",
    nav_backoffice: "ניהול",

    // ---------- Module Titles ----------
    mod_rawMaterials: "קבלת חומרי גלם",
    mod_dateReceiving: "קבלת תמרים",
    mod_fermentation: "תסיסה",
    mod_distillation1: "זיקוק 1",
    mod_distillation2: "זיקוק 2",
    mod_bottling: "ביקבוק",
    mod_inventory: "מלאי",
    mod_bottleInventory: "מלאי בקבוקים",
    mod_rawInventory: "מלאי חומרי גלם",
    mod_spiritStock: "צינור אלכוהול",

    // ---------- Spirit Pipeline ----------
    spirit_pipeline: "צינור הזיקוק",
    spirit_d1Label: "זיקוק ראשון (D1)",
    spirit_d2Label: "זיקוק שני (D2)",
    spirit_produced: "יוצר (ל')",
    spirit_consumed: "נוצל (ל')",
    spirit_available: "זמין (ל')",
    spirit_readyToBottle: "מוכן לביקבוק",
    spirit_noData: "אין רשומות זיקוק עדיין.",

    // ---------- Raw Materials ----------
    rm_supplier: "ספק",
    rm_receiveDate: "תאריך קבלה",
    rm_category: "קטגוריה",
    rm_item: "פריט ספציפי",
    rm_weight: "משקל / כמות",
    rm_unit: "יחידה",
    rm_expiry: "תאריך תפוגה",
    rm_tithing: "מעושר",
    rm_healthCert: "אישור משרד הבריאות",
    rm_kosher: "תעודת כשרות",
    rm_cat_spices: "תבלינים",
    rm_cat_labels: "תוויות",
    rm_cat_packaging: "אריזה",

    // ---------- Date Receiving ----------
    dr_supplier: "ספק",
    dr_receiveDate: "תאריך קבלה",
    dr_weight: "משקל (ק\"ג)",
    dr_tithing: "מעשר",
    dr_expiryPeriod: "תקופת תפוגה",
    dr_expiryPeriod_1year: "שנה",
    dr_expiryPeriod_custom: "מותאם אישית",
    dr_qtyInDate: "כמות בתמר",

    // ---------- Fermentation ----------
    fm_date: "תאריך",
    fm_tankSize: "גודל מיכל (ליטר)",
    fm_datesCrates: "מספר ארגזים (1 ארגז = 20 ק\"ג)",
    fm_temperature: "טמפרטורה (°C)",
    fm_sugar: "תכולת סוכר",
    fm_ph: "pH",
    fm_sentToDistillation: "נשלח לזיקוק",

    // ---------- Distillation 1 ----------
    d1_date: "תאריך",
    d1_type: "סוג",
    d1_stillName: "שם מזקק",
    d1_fermDate: "תאריך תסיסה",
    d1_distQty: "כמות זיקוק (ליטר)",
    d1_initAlcohol: "אלכוהול התחלתי %",
    d1_initTemp: "טמפרטורה התחלתית (°C)",
    d1_finalAlcohol: "אלכוהול סופי %",
    d1_temp: "טמפרטורה (°C)",
    d1_timeRange: "טווח זמן",
    d1_distilledQty: "כמות מזוקקת (ליטר)",
    d1_type_dist1: "זיקוק 1",
    d1_type_tailsArak: "זנבות - ערק",
    d1_type_tailsGin: "זנבות - ג'ין",
    d1_type_tailsEDV: "זנבות - EDV",
    d1_type_cleaning: "זיקוק ניקוי",
    d1_still_amiti: "עמיתי",
    d1_still_aladdin: "אלאדין",

    // ---------- Distillation 2 ----------
    d2_date: "תאריך",
    d2_productType: "סוג מוצר",
    d2_d1Dates: "תאריכי זיקוק 1",
    d2_batchNumber: "מספר אצווה",
    d2_initAlcohol: "אלכוהול התחלתי %",
    d2_headSep: "הפרדת ראש (5 ליטר)",
    d2_tailAlcohol: "הפרדת זנב %",
    d2_temp: "טמפרטורה (°C)",
    d2_timeRange: "טווח זמן",
    d2_quantity: "כמות (ליטר)",
    d2_d1InputQty: "כמות זיקוק 1 שנוצלה (ל')",

    // ---------- Bottling ----------
    bt_drinkType: "סוג משקה",
    bt_bottlingDate: "תאריך ביקבוק",
    bt_batchNumber: "מספר אצווה",
    bt_barrelNumber: "מספר חבית",
    bt_d2Date: "תאריך זיקוק 2",
    bt_alcohol: "אלכוהול %",
    bt_filtered: "מסונן",
    bt_color: "צבע",
    bt_taste: "טעם וריח",
    bt_contaminants: "נקי ממזהמים",
    bt_bottleCount: "מספר בקבוקים",
    bt_d2InputQty: "כמות זיקוק 2 שנוצלה (ל')",
    bt_decision: "החלטה",
    bt_qaSignature: "חתימת בקרת איכות",
    bt_pendingApproval: "ממתין לאישור",
    bt_approve: "אשר",

    // ---------- Drink Types ----------
    drink_arak: "ערק",
    drink_gin: "ג'ין",
    drink_edv: "EDV",
    drink_licorice: "ליקוריץ",
    drink_brandyVS: "ברנדי VS",
    drink_brandyVSOP: "ברנדי VSOP",
    drink_brandyMed: "ברנדי ים תיכוני",

    // ---------- Inventory ----------
    inv_drinkType: "סוג משקה",
    inv_warehouseQty: "כמות במחסן",
    inv_item: "פריט",
    inv_component: "רכיב",
    inv_unit: "יחידה",
    inv_stock: "מלאי",
    inv_bottles: "בקבוקים ופקקים",
    inv_labels: "תוויות",
    inv_spices: "תבלינים",
    inv_dates: "תמרים זמינים (ק\"ג)",
    inv_datesUsed: "תמרים בתסיסה (ק\"ג)",
    inv_cartons: "קרטונים",

    // ---------- Permissions ----------
    perm_denied: "אין לך הרשאה לגשת לתכונה זו",
    perm_managerOnly: "גישה למנהלים בלבד",
    perm_deleteConfirm: "האם אתה בטוח שברצונך למחוק רשומה זו?",

    // ---------- Misc UI ----------
    modulesLabel: "מודולים",
    pendingApprovals: "ממתין",
    recentActivity: "פעילות אחרונה",
    tapPlusToAdd: "לחץ + כדי להוסיף רשומה ראשונה",
    clearSignature: "נקה",
    keepCurrentPassword: "השאר ריק לשמירת הסיסמה הנוכחית",
    sessionExpired: "פג תוקף ההתחברות. אנא התחבר מחדש.",
    versionLabel: "גרסה",
    noGaps: "אין פערים",
    gapsLabel: "פערים",
    nameEnglish: "שם מלא (אנגלית/תאילנדית)",
    nameHebrew: "שם מלא (עברית)",

    // ---------- Suppliers ----------
    sup_tamartushka: "תמרטושקה",
    sup_nichuchot: "ניצוצות ארגמן",
    sup_iherb: "I-HERB",
    sup_shlr: "SH.L.R",
    sup_pcsi: "PCSI",
    sup_yakev: "יקב האלה",
    sup_selfHarvest: "קטיף עצמי",
    sup_gamliel: "גמליאל",
    sup_lara: "לארה",
    sup_other: "אחר",

    // ---------- Delete modal ----------
    deleteConfirmTitle: "נדרש אישור מנהל",
    deleteConfirmSubtitle: "הזן סיסמת מנהל לאישור המחיקה.",
    managerPasswordPlaceholder: "סיסמת מנהל",
    deleteWrongPassword: "סיסמת המנהל שגויה",
    cannotDeleteAdmin: "לא ניתן למחוק את חשבון המנהל הראשי",
    cannotDeleteSelf: "לא ניתן למחוק את החשבון שלך",

    // ---------- Custom options ----------
    addNewOption: "+ הוסף אפשרות חדשה…",
    newOptionPlaceholder: "הקלד אפשרות חדשה…",
    optionAdded: "האפשרות נוספה בהצלחה",

    // ---------- Inventory buffer ----------
    pendingChanges: "{n} עדכון/ים בהמתנה — יופיעו בעוד פחות מדקה",

    // ---------- Backoffice ----------
    backofficeSubtitle: "נהל חברי צוות, תפקידים ורמות גישה.",
    permAdmin: "מנהל-על — כל ההרשאות כולל אישור בקבוק",
    permManager: "גישה מלאה — יכול לצפות בכל העמודים, למחוק רשומות ולנהל משתמשים",
    permWorker: "גישה מוגבלת — יכול להוסיף רשומות, לא יכול למחוק או לגשת לניהול",
  },

  th: {
    // ---------- Global ----------
    appName: "ระบบควบคุมโรงงาน",
    langToggle: "עב",
    logout: "ออกจากระบบ",
    save: "บันทึก",
    cancel: "ยกเลิก",
    delete: "ลบ",
    edit: "แก้ไข",
    back: "กลับ",
    submit: "ส่ง",
    confirm: "ยืนยัน",
    yes: "ใช่",
    no: "ไม่",
    done: "เสร็จสิ้น",
    notDone: "ยังไม่เสร็จ",
    notes: "หมายเหตุ",
    date: "วันที่",
    today: "วันนี้",
    search: "ค้นหา…",
    noData: "ยังไม่มีข้อมูล",
    addNew: "เพิ่มใหม่",
    history: "ประวัติ",
    required: "จำเป็น",
    optional: "ไม่ต้องระบุ",
    saved: "บันทึกสำเร็จ!",
    exportCSV: "ส่งออก CSV",
    dashboard: "แดชบอร์ด",
    settings: "ตั้งค่า",
    recentEntries: "รายการล่าสุด",
    viewAll: "ดูทั้งหมด",
    totalRecords: "บันทึกทั้งหมด",
    normal: "ปกติ",
    abnormal: "ผิดปกติ",
    approved: "อนุมัติแล้ว",
    notApproved: "ไม่อนุมัติ",
    selectOne: "-- เลือก --",
    addNote: "เพิ่มบันทึก…",
    loginTitle: "ระบบควบคุมโรงงาน",
    loginSubtitle: "การบันทึกข้อมูลการผลิตแอลกอฮอล์",
    username: "ชื่อผู้ใช้",
    password: "รหัสผ่าน",
    login: "เข้าสู่ระบบ",
    loginError: "ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง",
    signUp: "สมัครสมาชิก",
    signUpTitle: "สร้างบัญชี",
    signUpSubtitle: "เข้าร่วมทีมโรงงาน",
    fullName: "ชื่อ-นามสกุล",
    confirmPassword: "ยืนยันรหัสผ่าน",
    selectRole: "เลือกบทบาท",
    alreadyHaveAccount: "มีบัญชีอยู่แล้ว?",
    dontHaveAccount: "ยังไม่มีบัญชี?",
    orContinueWith: "หรือดำเนินการต่อด้วย",
    signInWithGoogle: "เข้าสู่ระบบด้วย Google",
    googleSSONotRegistered: "บัญชี Google นี้ไม่ได้ลงทะเบียนในระบบ กรุณาติดต่อผู้ดูแล",
    googleSSONotReady: "Google Sign-In ยังไม่พร้อม กรุณาลองอีกครั้งในอีกสักครู่",
    signUpError_userExists: "ชื่อผู้ใช้ถูกใช้ไปแล้ว",
    signUpError_passwordMismatch: "รหัสผ่านไม่ตรงกัน",
    signUpError_passwordShort: "รหัสผ่านต้องมีอย่างน้อย 4 ตัวอักษร",
    signUpError_fillAll: "กรุณากรอกข้อมูลให้ครบทุกช่อง",
    signUpSuccess: "สร้างบัญชีสำเร็จ! คุณสามารถเข้าสู่ระบบได้แล้ว",
    role_manager: "ผู้จัดการ",
    role_worker: "พนักงาน",
    role_admin: "ผู้ดูแลระบบ",
    welcome: "ยินดีต้อนรับ",
    quickActions: "การดำเนินการด่วน",
    productionOverview: "ภาพรวมการผลิต",
    todayActivity: "กิจกรรมของวันนี้",
    lastActivity: "กิจกรรมล่าสุด",
    releaseVersion: "ออกเวอร์ชัน",
    inventoryHistory: "ประวัติรายการสินค้า",
    gapAnalysis: "การวิเคราะห์ส่วนต่าง",
    addNewSupplier: "เพิ่มผู้จำหน่ายใหม่…",
    supplierName: "ชื่อผู้จำหน่าย",
    emailInvite: "ส่งคำเชิญทางอีเมล",
    permissionsRules: "สิทธิ์และกฎการใช้งาน",

    // ---------- Backoffice ----------
    backoffice: "หลังบ้าน",
    userManagement: "การจัดการผู้ใช้",
    manageUsers: "จัดการผู้ใช้",
    addUser: "เพิ่มผู้ใช้",
    editUser: "แก้ไขผู้ใช้",
    deleteUser: "ลบผู้ใช้",
    userList: "รายชื่อผู้ใช้",
    permissions: "สิทธิ์การใช้งาน",
    active: "เปิดใช้งาน",
    inactive: "ปิดใช้งาน",
    lastLogin: "เข้าสู่ระบบล่าสุด",
    createdAt: "สร้างเมื่อ",
    actions: "การดำเนินการ",
    email: "อีเมล",
    phone: "โทรศัพท์",
    status: "สถานะ",

    // ---------- Nav ----------
    nav_dashboard: "แดชบอร์ด",
    nav_receiving: "การรับของ",
    nav_production: "การผลิต",
    nav_spiritStock: "สุรา",
    nav_bottling: "การบรรจุขวด",
    nav_inventory: "คลังสินค้า",
    nav_backoffice: "หลังบ้าน",

    // ---------- Module Titles ----------
    mod_rawMaterials: "การรับวัตถุดิบ",
    mod_dateReceiving: "การรับอินทผลัม",
    mod_fermentation: "การหมัก",
    mod_distillation1: "การกลั่นครั้งที่ 1",
    mod_distillation2: "การกลั่นครั้งที่ 2",
    mod_bottling: "การบรรจุขวด",
    mod_inventory: "คลังสินค้า",
    mod_bottleInventory: "คลังขวด",
    mod_rawInventory: "คลังวัตถุดิบ",
    mod_spiritStock: "ท่อสุรา",

    // ---------- Spirit Pipeline ----------
    spirit_pipeline: "ท่อการกลั่น",
    spirit_d1Label: "กลั่นครั้งที่ 1 (D1)",
    spirit_d2Label: "กลั่นครั้งที่ 2 (D2)",
    spirit_produced: "ผลิต (ล.)",
    spirit_consumed: "ใช้แล้ว (ล.)",
    spirit_available: "พร้อมใช้ (ล.)",
    spirit_readyToBottle: "พร้อมบรรจุขวด",
    spirit_noData: "ยังไม่มีข้อมูลการกลั่น",

    // Settings
    settings: "การตั้งค่า",
    dataExport: "สำรองข้อมูล",
    exportAllData: "ส่งออกฐานข้อมูลทั้งหมด (CSV)",
    confirmExport: "ดาวน์โหลดสำรองข้อมูลทั้งหมด?",

    // ---------- Google Sheets ----------
    sheetsIntegration: "การซิงค์ Google Sheets",
    viewInventorySheet: "ดูชีทสินค้าคงคลัง",
    sheetsUrl: "URL ของ Apps Script Web App",
    sheetsUrlPlaceholder: "https://script.google.com/macros/s/...",
    sheetsUrlHint: "วาง URL เพื่อซิงค์ข้อมูลทั้งหมดไปยัง Google Sheets โดยอัตโนมัติ",
    sheetsSave: "บันทึก URL",
    sheetsSaved: "บันทึก URL Google Sheets แล้ว ✓",
    sheetsTestConnection: "ทดสอบการเชื่อมต่อ",
    sheetsSyncAll: "ซิงค์ทั้งหมดตอนนี้",
    syncInProgress: "กำลังซิงค์...",
    syncSuccess: "ซิงค์สำเร็จ ✓",
    syncFailed: "ซิงค์ล้มเหลว — ตรวจสอบการเชื่อมต่อ",

    // ---------- Raw Materials ----------
    rm_supplier: "ผู้จำหน่าย",
    rm_receiveDate: "วันที่ได้รับ",
    rm_category: "หมวดหมู่",
    rm_item: "รายการเฉพาะ",
    rm_weight: "น้ำหนัก / จำนวน",
    rm_unit: "หน่วย",
    rm_expiry: "วันหมดอายุ",
    rm_tithing: "จ่ายทศางค์แล้ว",
    rm_healthCert: "ใบรับรองกระทรวงสาธารณสุข",
    rm_kosher: "ใบรับรองโคเชอร์",
    rm_cat_spices: "เครื่องเทศ",
    rm_cat_labels: "ฉลาก",
    rm_cat_packaging: "บรรจุภัณฑ์",

    // ---------- Date Receiving ----------
    dr_supplier: "ผู้จำหน่าย",
    dr_receiveDate: "วันที่ได้รับ",
    dr_weight: "น้ำหนัก (กก.)",
    dr_tithing: "การจ่ายทศางค์",
    dr_expiryPeriod: "ระยะเวลาหมดอายุ",
    dr_expiryPeriod_1year: "1 ปี",
    dr_expiryPeriod_custom: "กำหนดเอง",
    dr_qtyInDate: "จำนวนในวันที่",

    // ---------- Fermentation ----------
    fm_date: "วันที่",
    fm_tankSize: "ขนาดถัง (ลิตร)",
    fm_datesCrates: "จำนวนลัง (1 ลัง = 20 กก.)",
    fm_temperature: "อุณหภูมิ (°C)",
    fm_sugar: "ปริมาณน้ำตาล",
    fm_ph: "pH",
    fm_sentToDistillation: "ส่งไปกลั่น",

    // ---------- Distillation 1 ----------
    d1_date: "วันที่",
    d1_type: "ประเภท",
    d1_stillName: "ชื่อเครื่องกลั่น",
    d1_fermDate: "วันที่หมัก",
    d1_distQty: "ปริมาณการกลั่น (ลิตร)",
    d1_initAlcohol: "แอลกอฮอล์เริ่มต้น %",
    d1_initTemp: "อุณหภูมิเริ่มต้น (°C)",
    d1_finalAlcohol: "แอลกอฮอล์สุดท้าย %",
    d1_temp: "อุณหภูมิ (°C)",
    d1_timeRange: "ช่วงเวลา",
    d1_distilledQty: "ปริมาณที่กลั่นได้ (ลิตร)",
    d1_type_dist1: "การกลั่น 1",
    d1_type_tailsArak: "ส่วนหาง - อารัก",
    d1_type_tailsGin: "ส่วนหาง - จิน",
    d1_type_tailsEDV: "ส่วนหาง - EDV",
    d1_type_cleaning: "การกลั่นเพื่อทำความสะอาด",
    d1_still_amiti: "Amiti",
    d1_still_aladdin: "Aladdin",

    // ---------- Distillation 2 ----------
    d2_date: "วันที่",
    d2_productType: "ประเภทผลิตภัณฑ์",
    d2_d1Dates: "วันที่กลั่น 1",
    d2_batchNumber: "เลขรหัสการผลิต",
    d2_initAlcohol: "แอลกอฮอล์เริ่มต้น %",
    d2_headSep: "การแยกส่วนหัว (5 ลิตร)",
    d2_tailAlcohol: "การแยกส่วนหาง %",
    d2_temp: "อุณหภูมิ (°C)",
    d2_timeRange: "ช่วงเวลา",
    d2_quantity: "จำนวน (ลิตร)",
    d2_d1InputQty: "สุราจากกลั่น 1 ที่ใช้ (ล.)",

    // ---------- Bottling ----------
    bt_drinkType: "ประเภทเครื่องดื่ม",
    bt_bottlingDate: "วันที่บรรจุขวด",
    bt_batchNumber: "เลขรหัสการผลิต",
    bt_barrelNumber: "เลขถัง",
    bt_d2Date: "วันที่กลั่น 2",
    bt_alcohol: "แอลกอฮอล์ %",
    bt_filtered: "ผ่านการกรอง",
    bt_color: "สี",
    bt_taste: "รสชาติและกลิ่น",
    bt_contaminants: "ปราศจากสิ่งปนเปื้อน",
    bt_bottleCount: "จำนวนขวด",
    bt_d2InputQty: "สุราจากกลั่น 2 ที่ใช้ (ล.)",
    bt_decision: "การตัดสินใจ",
    bt_qaSignature: "ลายเซ็น QA",
    bt_pendingApproval: "รอการอนุมัติ",
    bt_approve: "อนุมัติ",

    // ---------- Drink Types ----------
    drink_arak: "Arak",
    drink_gin: "Gin",
    drink_edv: "EDV",
    drink_licorice: "Licorice",
    drink_brandyVS: "Brandy VS",
    drink_brandyVSOP: "Brandy VSOP",
    drink_brandyMed: "Mediterranean Brandy",

    // ---------- Inventory ----------
    inv_drinkType: "ประเภทเครื่องดื่ม",
    inv_warehouseQty: "จำนวนในคลัง",
    inv_item: "รายการ",
    inv_component: "ส่วนประกอบ",
    inv_unit: "หน่วย",
    inv_stock: "สต็อก",
    inv_bottles: "ขวดและจุก",
    inv_labels: "ฉลาก",
    inv_spices: "เครื่องเทศ",
    inv_dates: "อินทผลัมที่มี (กก.)",
    inv_datesUsed: "อินทผลัมในการหมัก (กก.)",
    inv_cartons: "กล่อง",

    // ---------- Permissions ----------
    perm_denied: "คุณไม่มีสิทธิ์เข้าถึงฟีเจอร์นี้",
    perm_managerOnly: "เข้าถึงได้เฉพาะผู้จัดการ",
    perm_deleteConfirm: "คุณแน่ใจหรือไม่ว่าต้องการลบบันทึกนี้?",

    // ---------- Misc UI ----------
    modulesLabel: "โมดูล",
    pendingApprovals: "รอดำเนินการ",
    recentActivity: "กิจกรรมล่าสุด",
    tapPlusToAdd: "แตะ + เพื่อเพิ่มรายการแรก",
    clearSignature: "ล้าง",
    keepCurrentPassword: "ปล่อยว่างเพื่อเก็บรหัสผ่านเดิม",
    sessionExpired: "เซสชันหมดอายุ กรุณาเข้าสู่ระบบใหม่",
    versionLabel: "เวอร์ชัน",
    noGaps: "ไม่มีส่วนต่าง",
    gapsLabel: "ส่วนต่าง",
    nameEnglish: "ชื่อ-นามสกุล (อังกฤษ/ไทย)",
    nameHebrew: "ชื่อ-นามสกุล (ภาษาฮีบรู)",

    // ---------- Suppliers ----------
    sup_tamartushka: "Tamartushka",
    sup_nichuchot: "Nichuchot Argaman",
    sup_iherb: "I-HERB",
    sup_shlr: "SH.L.R",
    sup_pcsi: "PCSI",
    sup_yakev: "Yakev HaEla",
    sup_selfHarvest: "เก็บเกี่ยวเอง",
    sup_gamliel: "Gamliel",
    sup_lara: "Lara",
    sup_other: "อื่นๆ",

    // ---------- Delete modal ----------
    deleteConfirmTitle: "ต้องการการอนุมัติจากผู้จัดการ",
    deleteConfirmSubtitle: "กรอกรหัสผ่านของผู้จัดการเพื่อยืนยันการลบ",
    managerPasswordPlaceholder: "รหัสผ่านผู้จัดการ",
    deleteWrongPassword: "รหัสผ่านผู้จัดการไม่ถูกต้อง",
    cannotDeleteAdmin: "ไม่สามารถลบบัญชีผู้ดูแลหลักได้",
    cannotDeleteSelf: "ไม่สามารถลบบัญชีของตัวเองได้",

    // ---------- Custom options ----------
    addNewOption: "+ เพิ่มตัวเลือกใหม่…",
    newOptionPlaceholder: "พิมพ์ตัวเลือกใหม่…",
    optionAdded: "เพิ่มตัวเลือกสำเร็จ",

    // ---------- Inventory buffer ----------
    pendingChanges: "{n} รายการรอดำเนินการ — จะปรากฏภายใน 1 นาที",

    // ---------- Backoffice ----------
    backofficeSubtitle: "จัดการสมาชิกทีม บทบาท และระดับการเข้าถึง",
    permAdmin: "ผู้ดูแลสูงสุด — สิทธิ์ทั้งหมด รวมถึงการอนุมัติการบรรจุขวด",
    permManager: "การเข้าถึงเต็มรูปแบบ — สามารถดูทุกหน้า ลบบันทึก และจัดการผู้ใช้",
    permWorker: "การเข้าถึงจำกัด — สามารถเพิ่มบันทึก ไม่สามารถลบหรือเข้าถึงการจัดการ",
  }
};

let currentLang = localStorage.getItem('factory_lang') || 'he';

function t(key) {
  return (I18N[currentLang] && I18N[currentLang][key]) || (I18N.en[key]) || key;
}

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('factory_lang', lang);
  document.documentElement.lang = lang;
  document.documentElement.dir = lang === 'he' ? 'rtl' : 'ltr';
  // Re-render current view
  if (typeof renderApp === 'function') renderApp();
}

function toggleLang() {
  // Toggle between hebrew and thai
  setLang(currentLang === 'he' ? 'th' : 'he');
}

    </script>
    <script>
// ============================================================
// auth.js — Authentication & Role Management
// ============================================================

// The two owner accounts — login is by email + password
const DEFAULT_USERS = [
  {
    username: 'guymaich',
    password: 'Guy1234',
    role: 'admin',
    name: 'Guy Maich',
    nameHe: 'גיא מייך',
    email: 'guymaich@gmail.com',
    status: 'active',
  },
  {
    username: 'yonatangarini',
    password: 'Yon1234',
    role: 'admin',
    name: 'Yonatan Garini',
    nameHe: 'יונתן גריני',
    email: 'yonatangarini@gmail.com',
    status: 'active',
  },
];

// Permissions map
const PERMISSIONS = {
  admin: {
    canViewDashboard: true,
    canAddRecords: true,
    canEditRecords: true,
    canDeleteRecords: true,
    canViewHistory: true,
    canExportData: true,
    canManageUsers: true,
    canViewInventory: true,
    canApproveBottling: true,
    canViewAllModules: true,
    canAccessBackoffice: true,
  },
  manager: {
    canViewDashboard: true,
    canAddRecords: true,
    canEditRecords: true,
    canDeleteRecords: true,
    canViewHistory: true,
    canExportData: true,
    canManageUsers: true,
    canViewInventory: true,
    canApproveBottling: false,
    canViewAllModules: true,
    canAccessBackoffice: true,
  },
  worker: {
    canViewDashboard: true,
    canAddRecords: true,
    canEditRecords: false,
    canDeleteRecords: false,
    canViewHistory: true,
    canExportData: false,
    canManageUsers: false,
    canViewInventory: true,
    canApproveBottling: false,
    canViewAllModules: true,
    canAccessBackoffice: false,
  }
};

function getUsers() {
  let users;
  try {
    users = JSON.parse(localStorage.getItem('factory_users') || 'null');
  } catch (e) {
    users = null;
  }
  if (!users || !Array.isArray(users)) {
    users = DEFAULT_USERS;
    localStorage.setItem('factory_users', JSON.stringify(users));
  } else {
    // Migration: ensure the two owner accounts always exist
    let changed = false;
    for (const required of DEFAULT_USERS) {
      if (!users.find(u => u.username === required.username)) {
        users.push(required);
        changed = true;
      }
    }
    if (changed) localStorage.setItem('factory_users', JSON.stringify(users));
  }
  return users;
}

// Authenticate by email (primary) or username, with password
function authenticate(emailOrUsername, password) {
  const users = getUsers();
  const user = users.find(u =>
    u.status !== 'inactive' &&
    u.password === password &&
    (
      (u.email && u.email.toLowerCase() === emailOrUsername.toLowerCase()) ||
      u.username.toLowerCase() === emailOrUsername.toLowerCase()
    )
  );
  if (user) {
    const session = { ...user, loginTime: Date.now() };
    delete session.password;
    localStorage.setItem('factory_session', JSON.stringify(session));
    return session;
  }
  return null;
}

// ============================================================
// Access Request System
// ============================================================
const ACCESS_REQUESTS_KEY = 'factory_access_requests';

function getPendingRequests() {
  try {
    return JSON.parse(localStorage.getItem(ACCESS_REQUESTS_KEY) || '[]');
  } catch (e) { return []; }
}

function submitAccessRequest(name, email) {
  if (!name || !email) return { success: false, error: 'requestError_fillAll' };

  const requests = getPendingRequests();
  if (requests.find(r => r.email.toLowerCase() === email.toLowerCase())) {
    return { success: false, error: 'requestError_alreadyPending' };
  }

  const users = getUsers();
  if (users.find(u => u.email && u.email.toLowerCase() === email.toLowerCase())) {
    return { success: false, error: 'requestError_emailExists' };
  }

  const request = {
    id: Date.now().toString(),
    name: name.trim(),
    email: email.trim().toLowerCase(),
    requestedAt: new Date().toISOString(),
  };

  requests.push(request);
  localStorage.setItem(ACCESS_REQUESTS_KEY, JSON.stringify(requests));
  return { success: true, request };
}

function approveRequest(requestId, password, role) {
  const requests = getPendingRequests();
  const req = requests.find(r => r.id === requestId);
  if (!req) return { success: false, error: 'Request not found' };

  const baseUsername = req.email.split('@')[0].replace(/[^a-zA-Z0-9]/g, '');
  const result = createUser({
    username: baseUsername,
    password: password || 'Welcome1',
    role: role || 'worker',
    name: req.name,
    email: req.email,
    status: 'active',
  });

  if (!result.success) return result;

  const updated = requests.filter(r => r.id !== requestId);
  localStorage.setItem(ACCESS_REQUESTS_KEY, JSON.stringify(updated));
  return { success: true };
}

function denyRequest(requestId) {
  const requests = getPendingRequests();
  const updated = requests.filter(r => r.id !== requestId);
  localStorage.setItem(ACCESS_REQUESTS_KEY, JSON.stringify(updated));
  return { success: true };
}

// Session expires after 12 hours of inactivity
const SESSION_TIMEOUT_MS = 12 * 60 * 60 * 1000;

function getSession() {
  let session;
  try {
    session = JSON.parse(localStorage.getItem('factory_session') || 'null');
  } catch (e) {
    localStorage.removeItem('factory_session');
    return null;
  }
  if (!session) return null;

  const now = Date.now();
  if (session.loginTime && (now - session.loginTime) > SESSION_TIMEOUT_MS) {
    localStorage.removeItem('factory_session');
    return null;
  }

  if (!session.username || !session.role) {
    localStorage.removeItem('factory_session');
    return null;
  }

  return session;
}

function logout() {
  localStorage.removeItem('factory_session');
  if (typeof renderApp === 'function') {
    currentScreen = 'dashboard';
    currentModule = null;
    renderApp();
  }
}

function secureRecordAction(action) {
  const session = getSession();
  if (!session) {
    alert(typeof t === 'function' ? t('sessionExpired') : 'Session expired. Please log in.');
    logout();
    return false;
  }
  return action();
}

function hasPermission(perm) {
  const session = getSession();
  if (!session) return false;
  return PERMISSIONS[session.role] && PERMISSIONS[session.role][perm];
}

function getUserDisplayName() {
  const session = getSession();
  if (!session) return '';
  if (currentLang === 'he') return session.nameHe || session.name;
  if (currentLang === 'th') return session.nameTh || session.name;
  return session.name;
}

function getUserRole() {
  const session = getSession();
  if (!session) return '';
  return session.role;
}

function updateUser(username, updates) {
  const users = getUsers();
  const idx = users.findIndex(u => u.username === username);
  if (idx !== -1) {
    users[idx] = { ...users[idx], ...updates, updatedAt: new Date().toISOString() };
    localStorage.setItem('factory_users', JSON.stringify(users));
    return { success: true };
  }
  return { success: false, error: 'User not found' };
}

function deleteUserByUsername(username) {
  const users = getUsers();
  const filtered = users.filter(u => u.username !== username);
  if (filtered.length < users.length) {
    localStorage.setItem('factory_users', JSON.stringify(filtered));
    return { success: true };
  }
  return { success: false, error: 'User not found' };
}

function createUser(userData) {
  const users = getUsers();
  if (users.find(u => u.username.toLowerCase() === userData.username.toLowerCase())) {
    return { success: false, error: 'signUpError_userExists' };
  }

  const newUser = {
    ...userData,
    createdAt: new Date().toISOString(),
    status: userData.status || 'active',
  };

  users.push(newUser);
  localStorage.setItem('factory_users', JSON.stringify(users));
  return { success: true };
}

    </script>
    <script>
// ============================================================
// data.js — Data Layer (Firebase + localStorage fallback)
// ============================================================

const STORE_KEYS = {
  rawMaterials: 'factory_rawMaterials',
  dateReceiving: 'factory_dateReceiving',
  fermentation: 'factory_fermentation',
  distillation1: 'factory_distillation1',
  distillation2: 'factory_distillation2',
  bottling: 'factory_bottling',
  inventoryVersions: 'factory_inventoryVersions',
  customSuppliers: 'factory_customSuppliers',
  users: 'factory_users',
};

// ---- localStorage helpers ----
function getData(key) {
  try {
    return JSON.parse(localStorage.getItem(key) || '[]');
  } catch (e) {
    console.warn('[data] Corrupted localStorage key:', key);
    localStorage.removeItem(key);
    return [];
  }
}

function setData(key, data) {
  localStorage.setItem(key, JSON.stringify(data));
  const session = JSON.parse(localStorage.getItem('factory_session') || 'null');
  if (session && session.username) {
    updateUserLastActivity(session.username);
  }
}

function updateUserLastActivity(username) {
  const users = JSON.parse(localStorage.getItem(STORE_KEYS.users) || '[]');
  const idx = users.findIndex(u => u.username === username);
  if (idx !== -1) {
    users[idx].lastActivity = new Date().toISOString();
    localStorage.setItem(STORE_KEYS.users, JSON.stringify(users));
  }
}

// ---- CRUD (localStorage, synced to Firebase when available) ----
function addRecord(key, record) {
  const data = getData(key);
  record.id = Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
  record.createdAt = new Date().toISOString();
  record.createdBy = getSession()?.username || 'unknown';
  data.unshift(record);
  setData(key, data);

  // Async sync to Firebase (fire-and-forget)
  if (typeof fbAdd === 'function') {
    fbAdd(key, record).catch(() => {});
  }

  return record;
}

function updateRecord(key, id, updates) {
  const data = getData(key);
  const idx = data.findIndex(r => r.id === id);
  if (idx !== -1) {
    data[idx] = { ...data[idx], ...updates, updatedAt: new Date().toISOString() };
    setData(key, data);

    if (typeof fbUpdate === 'function') {
      fbUpdate(key, id, updates).catch(() => {});
    }

    return data[idx];
  }
  return null;
}

function deleteRecord(key, id) {
  const data = getData(key);
  const filtered = data.filter(r => r.id !== id);
  setData(key, filtered);

  if (typeof fbDelete === 'function') {
    fbDelete(key, id).catch(() => {});
  }
}

function getRecordCount(key) {
  return getData(key).length;
}

function getTodayRecords(key) {
  const today = new Date().toISOString().slice(0, 10);
  return getData(key).filter(r => r.createdAt && r.createdAt.startsWith(today));
}

// ---- Custom Dropdown Options ----
// Store custom options per field key
function getCustomOptions(fieldKey) {
  return JSON.parse(localStorage.getItem('factory_customOptions_' + fieldKey) || '[]');
}

async function addCustomOption(fieldKey, value) {
  value = value.trim();
  if (!value) return;
  const opts = getCustomOptions(fieldKey);
  if (!opts.includes(value)) {
    opts.push(value);
    localStorage.setItem('factory_customOptions_' + fieldKey, JSON.stringify(opts));
  }
  // Sync to Firebase
  if (typeof fbAddCustomOption === 'function') {
    await fbAddCustomOption(fieldKey, value).catch(() => {});
  }
  return value;
}

// Legacy: keep getCustomSuppliers for backward compat
function getCustomSuppliers() {
  return getCustomOptions('supplier');
}

function addCustomSupplier(name) {
  const suppliers = getCustomOptions('supplier');
  if (!suppliers.includes(name)) {
    suppliers.push(name);
    localStorage.setItem('factory_customOptions_supplier', JSON.stringify(suppliers));
  }
  return name;
}

// ---- Inventory Versioning ----
function saveInventoryVersion(snapshot) {
  const versions = getData(STORE_KEYS.inventoryVersions);
  const prevVersion = versions.length > 0 ? versions[0] : null;

  const gaps = {};
  if (prevVersion) {
    Object.keys(snapshot.items).forEach(key => {
      const current = snapshot.items[key] || 0;
      const previous = prevVersion.items[key] || 0;
      gaps[key] = current - previous;
    });
  }

  const record = {
    version: versions.length + 1,
    items: snapshot.items,
    gaps: gaps,
    note: snapshot.note || '',
    createdAt: new Date().toISOString(),
    createdBy: snapshot.createdBy || getSession()?.username || 'unknown'
  };

  versions.unshift(record);
  setData(STORE_KEYS.inventoryVersions, versions);

  if (typeof fbAdd === 'function') {
    fbAdd(STORE_KEYS.inventoryVersions, record).catch(() => {});
  }

  return record;
}

// ---- Dropdown data ----
const SUPPLIERS_RAW = [
  'sup_tamartushka', 'sup_nichuchot', 'sup_iherb',
  'sup_shlr', 'sup_pcsi', 'sup_yakev', 'sup_selfHarvest', 'sup_other'
];

const SUPPLIERS_DATES = [
  'sup_gamliel', 'sup_lara', 'sup_selfHarvest', 'sup_other'
];

const CATEGORIES = ['rm_cat_spices', 'rm_cat_labels', 'rm_cat_packaging'];

const ITEMS_BY_CATEGORY = {
  rm_cat_spices: [
    'Anise Seeds / เมล็ดโป๊ยกั๊ก',
    'Star Anise / โป๊ยกั๊ก',
    'Licorice / ชะเอม',
    'Juniper / จูนิเปอร์',
    'Cardamom / กระวาน',
    'Cinnamon / อบเชย',
    'Chamomile / คาโมมายล์',
    'Coriander Seeds / เมล็ดผักชี',
    'Citrus Orange / ส้ม',
    'Citrus Lemon / มะนาว',
    'Jujube / พุทรา',
    'Carob / แคร็อบ',
    'Pennyroyal / เพนนีรอยัล',
    'Allspice / ออลสไปซ์',
    'Katlav / คัทลาฟ',
    'Mastic / มาสติก',
    'Terebinth / เทเรบินท์',
  ],
  rm_cat_labels: [
    'Arak Neck / ฉลากคออารัก',
    'Arak Body / ฉลากตัวอารัก',
    'Gin Neck / ฉลากคอจิน',
    'Gin Body / ฉลากตัวจิน',
    'EDV Neck / ฉลากคอ EDV',
    'EDV Body / ฉลากตัว EDV',
    'Licorice Neck / ฉลากคอชะเอม',
    'Licorice Body / ฉลากตัวชะเอม',
    'Brandy VS Neck / ฉลากคอบรั่นดี VS',
    'Brandy VS Body / ฉลากตัวบรั่นดี VS',
    'Brandy VSOP Neck / ฉลากคอบรั่นดี VSOP',
    'Brandy VSOP Body / ฉลากตัวบรั่นดี VSOP',
    'Cork Label Copper / ฉลากจุกทองแดง',
    'Cork Label Gold / ฉลากจุกทอง',
  ],
  rm_cat_packaging: [
    'Obulo Bottle (Brandy) / ขวดโอบูโล (บรั่นดี)',
    'Demos Bottle (Gin, EDV) / ขวดเดมอส (จิน, EDV)',
    'Lov Bottle (Arak, Licorice) / ขวดลอฟ (อารัก, ชะเอม)',
    'Demos Cork / จุกเดมอส',
    'Obulo/Lov Cork / จุกโอบูโล/ลอฟ',
    'Carton 6-Obulo / กล่อง 6 โอบูโล',
    'Carton 6-Demos / กล่อง 6 เดมอส',
    'Carton 6-Lov / กล่อง 6 ลอฟ',
    'Carton Single / กล่องเดี่ยว',
    'Carton 12-Obulo / กล่อง 12 โอบูโล',
    'Carton 12-Demos / กล่อง 12 เดมอส',
    'Carton 12-Lov / กล่อง 12 ลอฟ',
    'Barrels / ถังไม้โอ๊ค',
  ],
};

const TANK_SIZES = [400, 500, 900, 1000];

const DRINK_TYPES = [
  'drink_arak', 'drink_gin', 'drink_edv', 'drink_licorice',
  'drink_brandyVS', 'drink_brandyVSOP', 'drink_brandyMed'
];

const D1_TYPES = [
  'd1_type_dist1', 'd1_type_tailsArak', 'd1_type_tailsGin',
  'd1_type_tailsEDV', 'd1_type_cleaning'
];

const STILL_NAMES = ['d1_still_amiti', 'd1_still_aladdin'];

const D2_PRODUCT_TYPES = ['drink_edv', 'drink_arak', 'drink_gin'];

// ---- CSV Export ----
function exportToCSV(keyOrData, filename) {
  let data = Array.isArray(keyOrData) ? keyOrData : getData(keyOrData);
  if (data.length === 0) return;

  const headers = Object.keys(data[0]);
  const sanitizeCSV = (val) => {
    if (val === undefined || val === null) return '""';
    let s = typeof val === 'object' ? JSON.stringify(val) : String(val);
    s = s.replace(/"/g, '""');
    // Prevent CSV formula injection
    if (/^[=+\-@\t\r]/.test(s)) s = "'" + s;
    return '"' + s + '"';
  };

  const rowStrings = data.map(row =>
    headers.map(h => sanitizeCSV(row[h])).join(',')
  );

  const csvContent = headers.join(',') + '\n' + rowStrings.join('\n');
  const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.setAttribute('download', filename || 'export.csv');
  link.click();
  setTimeout(() => URL.revokeObjectURL(url), 10000);
}

function exportAllData() {
  const keys = [
    'factory_rawMaterials', 'factory_dateReceiving', 'factory_fermentation',
    'factory_distillation1', 'factory_distillation2', 'factory_bottling',
    'factory_inventoryVersions', 'factory_customSuppliers', 'factory_users'
  ];
  const today = new Date().toISOString().slice(0, 10);
  keys.forEach(key => {
    if (localStorage.getItem(key)) {
      exportToCSV(key, key + '_' + today + '.csv');
    }
  });
}

    </script>
</head>

<body>
    <div id="app"></div>
    <script>
// ============================================================
// script.js — Factory Control App (main controller)
// ============================================================

// ---------- State ----------
let currentScreen = 'dashboard';
let currentModule = null;   // which form/list is open
let currentView = 'list';   // 'list' | 'form' | 'detail'
let editingRecord = null;
let signatureCanvas = null;
let sigCtx = null;
let sigDrawing = false;
let _navDirection = 'none'; // 'forward' | 'back' | 'none' — for iOS-style transitions
const _scrollPositions = {}; // keyed by "screen:module" — preserves scroll on tab switch

// ---------- Helpers ----------
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const el = (tag, cls, html) => {
  const e = document.createElement(tag);
  if (cls) e.className = cls;
  if (html !== undefined) e.innerHTML = html;
  return e;
};

function todayStr() { return new Date().toISOString().slice(0, 10); }

function formatDate(d) {
  if (!d) return '-';
  try { return new Date(d).toLocaleDateString(currentLang === 'th' ? 'th-TH' : currentLang === 'he' ? 'he-IL' : 'en-GB'); }
  catch { return d; }
}

function showToast(msg) {
  let toast = $('.toast');
  if (!toast) {
    toast = el('div', 'toast');
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

// ============================================================
// GOOGLE SHEETS SYNC
// ============================================================
const SHEETS_SYNC_URL = 'https://script.google.com/macros/s/AKfycbyMJ9pWds3hN3Oup_X-gwyDq0mX_CECdldtXcGXSn8-RsRDC6JNLhhPLoDSPXvjVK3O/exec';
const INVENTORY_SHEET_URL = 'https://docs.google.com/spreadsheets/d/14rYu6QgRD2r4X4ZjOs45Rqtl4p0XOPvJfcs5BpY54EE/edit?gid=1634965365#gid=1634965365';

// Sync state for the visual indicator
let _syncQueue = 0;

// ── Sync infrastructure ──────────────────────────────────────

// Sends a POST to GAS. Always fire-and-forget (no-cors), with 1 retry and console logging.
async function postToSheets(payload) {
  const url = SHEETS_SYNC_URL;
  if (!url) {
    console.warn('[sync] No GAS URL configured — skipping sync');
    return;
  }

  _syncQueue++;
  updateSyncIndicator('syncing');

  const attempt = async (n) => {
    try {
      console.log(`[sync] POST attempt ${n + 1}:`, payload.sheetName, payload.action || 'replace', `(${(payload.records || []).length} records)`);
      await fetch(url, {
        method: 'POST',
        body: JSON.stringify(payload),
        mode: 'no-cors',
      });
      console.log(`[sync] POST sent:`, payload.sheetName);
      return true;
    } catch (err) {
      console.error(`[sync] POST failed (attempt ${n + 1}):`, err.message);
      if (n < 1) {
        console.log('[sync] Retrying in 2s...');
        await new Promise(r => setTimeout(r, 2000));
        return attempt(n + 1);
      }
      return false;
    }
  };

  const sent = await attempt(0);
  _syncQueue--;

  if (!sent) {
    updateSyncIndicator(_syncQueue > 0 ? 'syncing' : 'error');
    showToast(t('syncFailed'));
    return;
  }

  updateSyncIndicator(_syncQueue > 0 ? 'syncing' : 'success');
}

// Verifies sync via GET request (GAS doGet supports CORS — we can read the response)
async function verifySyncStatus(sheetName) {
  const url = SHEETS_SYNC_URL;
  if (!url) return { verified: false, error: 'no-url' };
  try {
    const resp = await fetch(`${url}?action=syncStatus&sheet=${encodeURIComponent(sheetName)}`);
    if (!resp.ok) return { verified: false, error: 'http-' + resp.status };
    const data = await resp.json();
    return { verified: true, ...data };
  } catch (err) {
    console.warn('[sync] Verification failed for', sheetName, err.message);
    return { verified: false, error: err.message };
  }
}

// Shows a small persistent pill in the corner: Syncing / Synced / Sync failed
function updateSyncIndicator(state) {
  let indicator = document.querySelector('.sync-indicator');
  if (!indicator) {
    indicator = document.createElement('div');
    indicator.className = 'sync-indicator';
    document.body.appendChild(indicator);
  }

  indicator.className = 'sync-indicator sync-' + state;

  switch (state) {
    case 'syncing':
      indicator.innerHTML = '<span class="sync-dot pulse"></span>' + t('syncInProgress');
      break;
    case 'success':
      indicator.innerHTML = '<span class="sync-dot green"></span>' + t('syncSuccess');
      setTimeout(() => { if (indicator.classList.contains('sync-success')) indicator.classList.add('sync-fade'); }, 4000);
      break;
    case 'error':
      indicator.innerHTML = '<span class="sync-dot red"></span>' + t('syncFailed');
      break;
    default:
      indicator.classList.add('sync-fade');
  }
}

// ── Module sync ───────────────────────────────────────────────

function syncModuleToSheets(module) {
  const url = SHEETS_SYNC_URL;
  if (!url) return;

  const storeKey = STORE_KEYS[module];
  if (!storeKey) return;

  const records = getData(storeKey);

  // Build field definitions — bypass permission filter for sync
  // so decision/all fields always appear in the sheet regardless of who is logged in
  const allModuleFields = {
    rawMaterials: [
      { key: 'date', labelKey: 'rm_receiveDate' },
      { key: 'supplier', labelKey: 'rm_supplier' },
      { key: 'category', labelKey: 'rm_category' },
      { key: 'item', labelKey: 'rm_item' },
      { key: 'weight', labelKey: 'rm_weight' },
      { key: 'unit', labelKey: 'rm_unit' },
      { key: 'expiry', labelKey: 'rm_expiry' },
      { key: 'tithing', labelKey: 'rm_tithing' },
      { key: 'healthCert', labelKey: 'rm_healthCert' },
      { key: 'kosher', labelKey: 'rm_kosher' },
    ],
    dateReceiving: [
      { key: 'date', labelKey: 'dr_receiveDate' },
      { key: 'supplier', labelKey: 'dr_supplier' },
      { key: 'weight', labelKey: 'dr_weight' },
      { key: 'tithing', labelKey: 'dr_tithing' },
      { key: 'expiryPeriod', labelKey: 'dr_expiryPeriod' },
      { key: 'qtyInDate', labelKey: 'dr_qtyInDate' },
    ],
    fermentation: [
      { key: 'date', labelKey: 'fm_date' },
      { key: 'tankSize', labelKey: 'fm_tankSize' },
      { key: 'datesCrates', labelKey: 'fm_datesCrates' },
      { key: 'temperature', labelKey: 'fm_temperature' },
      { key: 'sugar', labelKey: 'fm_sugar' },
      { key: 'ph', labelKey: 'fm_ph' },
      { key: 'sentToDistillation', labelKey: 'fm_sentToDistillation' },
    ],
    distillation1: [
      { key: 'date', labelKey: 'd1_date' },
      { key: 'type', labelKey: 'd1_type' },
      { key: 'stillName', labelKey: 'd1_stillName' },
      { key: 'fermDate', labelKey: 'd1_fermDate' },
      { key: 'distQty', labelKey: 'd1_distQty' },
      { key: 'initAlcohol', labelKey: 'd1_initAlcohol' },
      { key: 'finalAlcohol', labelKey: 'd1_finalAlcohol' },
      { key: 'temp', labelKey: 'd1_temp' },
      { key: 'timeRange', labelKey: 'd1_timeRange' },
      { key: 'distilledQty', labelKey: 'd1_distilledQty' },
    ],
    distillation2: [
      { key: 'date', labelKey: 'd2_date' },
      { key: 'productType', labelKey: 'd2_productType' },
      { key: 'd1Dates', labelKey: 'd2_d1Dates' },
      { key: 'batchNumber', labelKey: 'd2_batchNumber' },
      { key: 'initAlcohol', labelKey: 'd2_initAlcohol' },
      { key: 'headSep', labelKey: 'd2_headSep' },
      { key: 'tailAlcohol', labelKey: 'd2_tailAlcohol' },
      { key: 'temp', labelKey: 'd2_temp' },
      { key: 'timeRange', labelKey: 'd2_timeRange' },
      { key: 'quantity', labelKey: 'd2_quantity' },
      { key: 'd1InputQty', labelKey: 'd2_d1InputQty' },
    ],
    bottling: [
      { key: 'date', labelKey: 'bt_bottlingDate' },
      { key: 'drinkType', labelKey: 'bt_drinkType' },
      { key: 'batchNumber', labelKey: 'bt_batchNumber' },
      { key: 'barrelNumber', labelKey: 'bt_barrelNumber' },
      { key: 'd2Date', labelKey: 'bt_d2Date' },
      { key: 'alcohol', labelKey: 'bt_alcohol' },
      { key: 'filtered', labelKey: 'bt_filtered' },
      { key: 'color', labelKey: 'bt_color' },
      { key: 'taste', labelKey: 'bt_taste' },
      { key: 'contaminants', labelKey: 'bt_contaminants' },
      { key: 'bottleCount', labelKey: 'bt_bottleCount' },
      { key: 'd2InputQty', labelKey: 'bt_d2InputQty' },
      { key: 'decision', labelKey: 'bt_decision' },
    ],
  };

  const fields = allModuleFields[module];
  if (!fields) return;

  const keys = [...fields.map(f => f.key), 'notes', 'createdAt'];
  const labels = [...fields.map(f => t(f.labelKey)), t('notes'), 'Created At'];

  postToSheets({
    sheetName: t('mod_' + module),
    keys,
    labels,
    records,
  });
}


// ============================================================
// THEME
// ============================================================
function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme') || 'light';
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('factory_theme', next);
  // Update icons without a full re-render
  const btn = document.querySelector('.theme-btn');
  if (btn) btn.innerHTML = next === 'dark'
    ? '<i data-feather="sun" style="width:14px;height:14px"></i>'
    : '<i data-feather="moon" style="width:14px;height:14px"></i>';
  if (typeof feather !== 'undefined') feather.replace();
}

// Append a timestamped inventory snapshot row to the Sheets Inventory ledger.
// Called automatically after any record is saved, updated, or deleted.
function syncInventorySnapshot(triggeredBy) {
  const url = SHEETS_SYNC_URL;
  if (!url) return;

  const bottlingRecords = getData(STORE_KEYS.bottling);
  const rawRecords = getData(STORE_KEYS.rawMaterials);
  const dateRecords = getData(STORE_KEYS.dateReceiving);
  const fermRecords = getData(STORE_KEYS.fermentation);
  const d1Records = getData(STORE_KEYS.distillation1);
  const d2Records = getData(STORE_KEYS.distillation2);

  const bottleInv = {};
  DRINK_TYPES.forEach(dt => { bottleInv[dt] = 0; });
  bottlingRecords.forEach(r => {
    if (r.drinkType && r.decision === 'approved') {
      bottleInv[r.drinkType] = (bottleInv[r.drinkType] || 0) + (parseInt(r.bottleCount) || 0);
    }
  });

  const totalDatesReceived = dateRecords.reduce((sum, r) => sum + (parseFloat(r.weight) || 0), 0);
  const totalDatesInFerm = fermRecords.reduce((sum, r) => {
    if (r.datesCrates !== undefined && r.datesCrates !== '') return sum + (parseFloat(r.datesCrates) || 0) * 20;
    return sum + (parseFloat(r.datesKg) || 0);
  }, 0);

  const d1Produced = d1Records.reduce((sum, r) => sum + (parseFloat(r.distilledQty) || 0), 0);
  const d1Consumed = d2Records.reduce((sum, r) => sum + (parseFloat(r.d1InputQty) || 0), 0);
  const d2Produced = d2Records.reduce((sum, r) => sum + (parseFloat(r.quantity) || 0), 0);
  const d2Consumed = bottlingRecords.reduce((sum, r) => sum + (parseFloat(r.d2InputQty) || 0), 0);

  const session = getSession();
  const record = {
    timestamp: new Date().toISOString(),
    user: session?.username || 'unknown',
    triggeredBy: triggeredBy || 'save',
    dates_available: Math.max(0, totalDatesReceived - totalDatesInFerm),
    dates_received: totalDatesReceived,
    dates_in_ferm: totalDatesInFerm,
    d1_produced: d1Produced,
    d1_available: Math.max(0, d1Produced - d1Consumed),
    d2_produced: d2Produced,
    d2_available: Math.max(0, d2Produced - d2Consumed),
    ...DRINK_TYPES.reduce((acc, dt) => ({ ...acc, [dt]: bottleInv[dt] || 0 }), {}),
  };

  const keys = Object.keys(record);
  const labels = [
    'Timestamp', 'User', 'Triggered By',
    t('inv_dates'), 'Dates Received (kg)', t('inv_datesUsed'),
    'D1 Produced (L)', 'D1 Available (L)',
    'D2 Produced (L)', 'D2 Available (L)',
    ...DRINK_TYPES.map(dt => t(dt)),
  ];

  postToSheets({
    sheetName: t('mod_inventory'),
    action: 'append',
    keys,
    labels,
    records: [record],
  });
}

// ---- Manager Password Modal (required for any delete action) ----
function showManagerPasswordModal(onSuccess) {
  // Remove any existing modal
  const existing = document.querySelector('.manager-pwd-modal');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.className = 'manager-pwd-modal';
  modal.innerHTML = `
    <div class="manager-pwd-backdrop"></div>
    <div class="manager-pwd-dialog">
      <div class="mpd-title"><i data-feather="lock" style="width:20px;height:20px;margin-inline-end:8px;"></i>${t('deleteConfirmTitle')}</div>
      <p class="mpd-subtitle">${t('deleteConfirmSubtitle')}</p>
      <input type="password" class="form-input mpd-input" id="mpd-password" placeholder="${t('managerPasswordPlaceholder')}" autocomplete="current-password">
      <div class="mpd-error" id="mpd-error"></div>
      <div class="mpd-actions">
        <button class="btn btn-secondary mpd-cancel">${t('cancel')}</button>
        <button class="btn btn-danger mpd-confirm">${t('delete')}</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  if (typeof feather !== 'undefined') feather.replace();

  const input = modal.querySelector('#mpd-password');
  const errorEl = modal.querySelector('#mpd-error');
  input.focus();

  const close = () => modal.remove();

  modal.querySelector('.mpd-cancel').addEventListener('click', close);
  modal.querySelector('.manager-pwd-backdrop').addEventListener('click', close);

  const doConfirm = () => {
    const pwd = input.value;
    if (!pwd) { errorEl.textContent = t('required'); return; }

    // Verify: must be a manager or admin password
    const users = getUsers();
    const authorized = users.find(
      u => (u.role === 'manager' || u.role === 'admin') && u.password === pwd
    );
    if (!authorized) {
      errorEl.textContent = t('deleteWrongPassword');
      input.value = '';
      input.focus();
      return;
    }
    close();
    onSuccess(authorized);
  };

  modal.querySelector('.mpd-confirm').addEventListener('click', doConfirm);
  input.addEventListener('keydown', e => { if (e.key === 'Enter') doConfirm(); });
}

// ---------- Main Render ----------
function renderApp() {
  const app = $('#app');
  const session = getSession();

  if (!session) {
    app.innerHTML = renderLogin();
    if (typeof feather !== 'undefined') feather.replace();
    bindLogin();
    return;
  }

  app.innerHTML = `
    ${renderHeader()}
    <div class="screen-content" id="screen-content"></div>
    ${renderBottomNav()}
  `;

  const content = $('#screen-content');

  // Apply iOS-style transition direction class
  if (_navDirection === 'forward') content.classList.add('nav-forward');
  else if (_navDirection === 'back') content.classList.add('nav-back');
  _navDirection = 'none'; // reset after applying

  if (currentModule && currentView === 'form') {
    renderModuleForm(content);
  } else if (currentModule && currentView === 'detail') {
    renderModuleDetail(content);
  } else if (currentModule && currentView === 'list') {
    renderModuleList(content);
  } else if (currentScreen === 'pendingRequests') {
    renderPendingRequests(content);
  } else if (currentScreen === 'backoffice') {
    renderBackoffice(content);
  } else {
    renderDashboard(content);
  }

  if (typeof feather !== 'undefined') feather.replace();
  bindNav();
  checkSecurity();

  // Restore scroll position if we saved one for this view
  const scrollKey = (currentModule || currentScreen) + ':' + currentView;
  if (_scrollPositions[scrollKey]) {
    content.scrollTop = _scrollPositions[scrollKey];
  }
}

function checkSecurity() {
  const session = getSession();
  if (!session && currentScreen !== 'login') {
    currentScreen = 'dashboard'; // Reset
    renderApp();
  }
}

// ============================================================
// LOGIN & REQUEST ACCESS
// ============================================================
let authMode = 'login'; // 'login' | 'request'

// Date-palm SVG mark — the Arava region's signature crop + distillery theme
const ARAVA_MARK_SVG = `
  <svg viewBox="0 0 36 48" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <line x1="18" y1="46" x2="18" y2="22" stroke="#EFEFEC" stroke-width="1.4" stroke-linecap="round"/>
    <path d="M18 22 C18 22 9 15 3 10 C9 13 15 20 18 24" fill="#EFEFEC" opacity="0.90"/>
    <path d="M18 22 C18 22 27 15 33 10 C27 13 21 20 18 24" fill="#EFEFEC" opacity="0.90"/>
    <path d="M18 28 C18 28 8 22 1 21 C8 22 15 27 18 30" fill="#EFEFEC" opacity="0.60"/>
    <path d="M18 28 C18 28 28 22 35 21 C28 22 21 27 18 30" fill="#EFEFEC" opacity="0.60"/>
    <path d="M18 22 C18 12 17 6 18 2 C19 6 18 12 18 22" fill="#EFEFEC" opacity="0.85"/>
  </svg>`;

function renderLogin() {
  if (authMode === 'request') return renderRequestAccess();

  return `
    <button class="login-lang-toggle" onclick="toggleLang()">${t('langToggle')}</button>
    <div class="login-screen">

      <div class="login-brand">
        <div class="login-logo-mark">${ARAVA_MARK_SVG}</div>
        <h1 class="login-brand-name">${t('loginTitle')}</h1>
        <p class="login-brand-sub">${t('loginSubtitle')}</p>
        <div class="login-brand-rule"></div>
      </div>

      <div class="login-form">
        <div class="field">
          <input type="email" id="login-user" placeholder="${t('emailAddress')}"
            autocomplete="email" autocapitalize="none" spellcheck="false">
        </div>
        <div class="field">
          <input type="password" id="login-pass" placeholder="${t('password')}"
            autocomplete="current-password">
        </div>
        <button class="login-btn" id="login-btn">${t('login')}</button>
        <div class="login-error" id="login-error"></div>
      </div>

      <div class="login-switch">
        ${t('dontHaveAccount')} <a href="#" id="go-request">${t('requestAccess')}</a>
      </div>
    </div>
  `;
}

function renderRequestAccess() {
  return `
    <button class="login-lang-toggle" onclick="toggleLang()">${t('langToggle')}</button>
    <div class="login-screen">

      <div class="login-brand">
        <div class="login-logo-mark">${ARAVA_MARK_SVG}</div>
        <div class="login-brand-name">Arava</div>
        <div class="login-brand-sub">${t('requestAccessTitle')}</div>
        <div class="login-brand-rule"></div>
      </div>

      <p style="font-size:13px;color:var(--text-secondary);margin-bottom:24px;max-width:280px;line-height:1.6">
        ${t('requestAccessSubtitle')}
      </p>

      <div class="login-form">
        <div class="field">
          <input type="text" id="req-name" placeholder="${t('fullName')}" autocomplete="name">
        </div>
        <div class="field">
          <input type="email" id="req-email" placeholder="${t('emailAddress')}"
            autocomplete="email" autocapitalize="none" spellcheck="false">
        </div>
        <button class="login-btn" id="req-btn">${t('requestAccessBtn')}</button>
        <div class="login-error" id="req-error"></div>
        <div class="login-success" id="req-success"></div>
      </div>

      <div class="login-switch">
        ${t('alreadyHaveAccount')} <a href="#" id="go-login">${t('login')}</a>
      </div>
    </div>
  `;
}

function bindLogin() {
  // --- Login ---
  const loginBtn = $('#login-btn');
  if (loginBtn) {
    const userInput = $('#login-user');
    const passInput = $('#login-pass');
    const errEl = $('#login-error');

    const doLogin = () => {
      const email = userInput.value.trim();
      const pass = passInput.value;
      if (!email || !pass) return;
      const session = authenticate(email, pass);
      if (session) {
        currentScreen = 'dashboard';
        currentModule = null;
        renderApp();
      } else {
        errEl.textContent = t('loginError');
      }
    };

    loginBtn.addEventListener('click', doLogin);
    passInput.addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
  }

  // --- Request Access ---
  const reqBtn = $('#req-btn');
  if (reqBtn) {
    const nameInput = $('#req-name');
    const emailInput = $('#req-email');
    const errEl = $('#req-error');
    const successEl = $('#req-success');

    const doRequest = () => {
      errEl.textContent = '';
      successEl.textContent = '';

      const result = submitAccessRequest(nameInput.value.trim(), emailInput.value.trim());

      if (result.success) {
        // Notify admins via GAS webhook (fire-and-forget)
        notifyAdminsOfRequest(result.request);
        successEl.textContent = t('requestSent');
        nameInput.value = '';
        emailInput.value = '';
        setTimeout(() => { authMode = 'login'; renderApp(); }, 2500);
      } else {
        errEl.textContent = t(result.error) || result.error;
      }
    };

    reqBtn.addEventListener('click', doRequest);
    emailInput.addEventListener('keydown', e => { if (e.key === 'Enter') doRequest(); });
  }

  // --- Toggle login ↔ request access ---
  const goRequest = $('#go-request');
  if (goRequest) {
    goRequest.addEventListener('click', e => {
      e.preventDefault();
      authMode = 'request';
      renderApp();
    });
  }

  const goLogin = $('#go-login');
  if (goLogin) {
    goLogin.addEventListener('click', e => {
      e.preventDefault();
      authMode = 'login';
      renderApp();
    });
  }
}

// ============================================================
// HEADER
// ============================================================
function renderHeader() {
  const session = getSession();
  const showBack = currentModule !== null || currentScreen === 'pendingRequests';
  const title = currentModule ? getModuleTitle(currentModule)
    : currentScreen === 'backoffice' ? t('nav_backoffice')
    : currentScreen === 'pendingRequests' ? t('pendingRequestsTitle')
    : t('appName');
  const roleClass = session.role === 'worker' ? 'worker' : '';

  return `
    <div class="app-header">
      <div class="header-left">
        ${showBack ? `<button class="header-back" id="header-back"><i data-feather="arrow-left"></i></button>` : ''}
        <span class="user-badge"><span class="role-dot ${roleClass}"></span>${getUserDisplayName()}</span>
      </div>
      <span class="header-title">${title}</span>
      <div class="header-right">
        ${session.role === 'admin' ? (() => {
          const pending = getPendingRequests().length;
          return pending > 0
            ? `<button class="notif-btn" onclick="currentScreen='pendingRequests';renderApp()" title="${t('pendingRequestsTitle')}">
                <i data-feather="bell" style="width:16px;height:16px"></i>
                <span class="notif-badge">${pending}</span>
               </button>`
            : '';
        })() : ''}
        <button class="theme-btn" onclick="toggleTheme()">
          ${(document.documentElement.getAttribute('data-theme') || 'light') === 'dark'
            ? '<i data-feather="sun" style="width:14px;height:14px"></i>'
            : '<i data-feather="moon" style="width:14px;height:14px"></i>'}
        </button>
        <button class="lang-btn" onclick="toggleLang()">${t('langToggle')}</button>
        <button class="logout-btn" id="logout-btn"><i data-feather="log-out" style="width:14px;height:14px"></i></button>
      </div>
    </div>
  `;
}

function getModuleTitle(mod) {
  const map = {
    rawMaterials: 'mod_rawMaterials',
    dateReceiving: 'mod_dateReceiving',
    fermentation: 'mod_fermentation',
    distillation1: 'mod_distillation1',
    distillation2: 'mod_distillation2',
    bottling: 'mod_bottling',
    inventory: 'mod_inventory',
    spiritStock: 'mod_spiritStock',
  };
  return t(map[mod] || mod);
}

// ============================================================
// BOTTOM NAV
// ============================================================
function renderBottomNav() {
  const items = [
    { id: 'dashboard', icon: 'grid', label: 'nav_dashboard' },
    { id: 'receiving', icon: 'package', label: 'nav_receiving' },
    { id: 'production', icon: 'activity', label: 'nav_production' },
    { id: 'spiritStock', icon: 'droplet', label: 'nav_spiritStock' },
    { id: 'bottling', icon: 'check-circle', label: 'nav_bottling' },
    { id: 'inventory', icon: 'database', label: 'nav_inventory' },
  ];

  if (hasPermission('canManageUsers')) {
    items.push({ id: 'backoffice', icon: 'settings', label: 'nav_backoffice' });
  }

  return `
    <nav class="bottom-nav">
      ${items.map(it => `
        <button class="nav-item ${currentScreen === it.id ? 'active' : ''}" data-nav="${it.id}">
          <i data-feather="${it.icon}"></i>
          ${t(it.label)}
        </button>
      `).join('')}
    </nav>
  `;
}

function bindNav() {
  // Save current scroll before navigating away
  function saveScroll() {
    const sc = $('#screen-content');
    if (sc) _scrollPositions[(currentModule || currentScreen) + ':' + currentView] = sc.scrollTop;
  }

  // Bottom nav
  $$('.nav-item').forEach(btn => {
    btn.addEventListener('click', () => {
      saveScroll();
      const nav = btn.dataset.nav;
      _navDirection = 'forward';
      currentScreen = nav;
      currentView = 'list';
      editingRecord = null;

      if (nav === 'dashboard') { currentModule = null; _navDirection = 'back'; }
      else if (nav === 'receiving') { currentModule = 'rawMaterials'; }
      else if (nav === 'production') { currentModule = 'fermentation'; }
      else if (nav === 'spiritStock') { currentModule = 'spiritStock'; }
      else if (nav === 'bottling') { currentModule = 'bottling'; }
      else if (nav === 'inventory') { currentModule = 'inventory'; }
      else if (nav === 'backoffice') { currentModule = null; }

      renderApp();
    });
  });

  // Back button
  const backBtn = $('#header-back');
  if (backBtn) {
    backBtn.addEventListener('click', () => {
      saveScroll();
      _navDirection = 'back';
      if (currentView === 'form' || currentView === 'detail') {
        currentView = 'list';
        editingRecord = null;
      } else {
        currentModule = null;
        currentScreen = 'dashboard';
      }
      renderApp();
    });
  }

  // Logout
  const logoutBtn = $('#logout-btn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      logout();
      renderApp();
    });
  }
}

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard(container) {
  const session = getSession();
  const modules = [
    { key: 'rawMaterials', icon: 'package', store: STORE_KEYS.rawMaterials, color: 'var(--color-receiving)' },
    { key: 'dateReceiving', icon: 'sun', store: STORE_KEYS.dateReceiving, color: 'var(--color-dates)' },
    { key: 'fermentation', icon: 'thermometer', store: STORE_KEYS.fermentation, color: 'var(--color-fermentation)' },
    { key: 'distillation1', icon: 'droplet', store: STORE_KEYS.distillation1, color: 'var(--color-dist1)' },
    { key: 'distillation2', icon: 'filter', store: STORE_KEYS.distillation2, color: 'var(--color-dist2)' },
    { key: 'bottling', icon: 'check-circle', store: STORE_KEYS.bottling, color: 'var(--color-bottling)' },
    { key: 'inventory', icon: 'database', store: null, color: 'var(--color-inventory)' },
  ];

  const totalRecords = Object.values(STORE_KEYS).reduce((sum, k) => sum + getRecordCount(k), 0);
  const todayTotal = Object.values(STORE_KEYS).reduce((sum, k) => sum + getTodayRecords(k).length, 0);

  // Pending approvals: bottling records without a decision
  const bottlingRecords = getData(STORE_KEYS.bottling);
  const pendingApprovals = bottlingRecords.filter(r => !r.decision || (r.decision !== 'approved' && r.decision !== 'notApproved')).length;

  // Recent activity: latest 5 records across all modules
  const recentRecords = [];
  const moduleEntries = modules.filter(m => m.store);
  moduleEntries.forEach(m => {
    getData(m.store).forEach(r => {
      recentRecords.push({ ...r, _module: m.key, _icon: m.icon, _color: m.color });
    });
  });
  recentRecords.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
  const topRecent = recentRecords.slice(0, 5);

  container.innerHTML = `
    <div class="welcome-card">
      <div style="font-size:9px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:rgba(239,239,236,0.45);margin-bottom:10px;font-family:'Quattrocento Sans',sans-serif">Arava Distillery · Production Control</div>
      <h2>${t('welcome')}, ${getUserDisplayName()}</h2>
      <p>${new Date().toLocaleDateString(currentLang === 'th' ? 'th-TH' : currentLang === 'he' ? 'he-IL' : 'en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
    </div>

    <div class="stats-row" style="grid-template-columns:1fr 1fr 1fr;margin-bottom:16px;">
      <div class="stat-card">
        <div class="stat-num">${todayTotal}</div>
        <div class="stat-label">${t('todayActivity')}</div>
      </div>
      <div class="stat-card">
        <div class="stat-num">${totalRecords}</div>
        <div class="stat-label">${t('totalRecords')}</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" style="color:var(--warning,#f59e0b)">${pendingApprovals}</div>
        <div class="stat-label">${t('pendingApprovals')}</div>
      </div>
    </div>

    <div class="section-title">${t('quickActions')}</div>
    <div class="module-grid">
      ${modules.map(m => `
        <div class="module-card" data-module="${m.key}">
          <div class="mc-icon"><i data-feather="${m.icon}"></i></div>
          <div class="mc-title">${getModuleTitle(m.key)}</div>
          <div class="mc-count">${m.store ? getRecordCount(m.store) + ' ' + t('totalRecords').toLowerCase() : ''}</div>
        </div>
      `).join('')}
    </div>

    ${topRecent.length ? `
      <div class="section-title" style="margin-top:24px;">${t('recentActivity')}</div>
      ${topRecent.map(r => {
        const title = r.item || r.supplier || r.drinkType || r.type || r.batchNumber || getModuleTitle(r._module);
        const time = r.createdAt ? formatDate(r.createdAt) : '';
        return `
          <div class="recent-activity-item" data-ra-module="${r._module}" data-ra-id="${r.id}">
            <div class="ra-icon" style="background:${r._color}20;color:${r._color}"><i data-feather="${r._icon}"></i></div>
            <div class="ra-content">
              <div class="ra-title">${title}</div>
              <div class="ra-meta">${getModuleTitle(r._module)} &bull; ${time}</div>
            </div>
          </div>`;
      }).join('')}
    ` : ''}
  `;

  // Bind module cards
  container.querySelectorAll('.module-card').forEach(card => {
    card.addEventListener('click', () => {
      currentModule = card.dataset.module;
      currentView = 'list';
      _navDirection = 'forward';
      renderApp();
    });
  });

  // Bind recent activity items
  container.querySelectorAll('.recent-activity-item').forEach(item => {
    item.addEventListener('click', () => {
      const mod = item.dataset.raModule;
      const id = item.dataset.raId;
      const storeKey = STORE_KEYS[mod];
      if (storeKey) {
        const record = getData(storeKey).find(r => r.id === id);
        if (record) {
          currentModule = mod;
          editingRecord = record;
          currentView = 'detail';
          _navDirection = 'forward';
          renderApp();
        }
      }
    });
  });
}

// ============================================================
// MODULE LIST VIEW
// ============================================================
function renderModuleList(container) {
  if (currentModule === 'inventory') {
    renderInventory(container);
    return;
  }
  if (currentModule === 'spiritStock') {
    renderSpiritStock(container);
    return;
  }

  const storeKey = STORE_KEYS[currentModule];
  if (!storeKey) { container.innerHTML = '<p>Unknown module</p>'; return; }

  // Sub-tabs for receiving and production
  let tabs = null;
  if (currentModule === 'rawMaterials' || currentModule === 'dateReceiving') {
    tabs = [
      { key: 'rawMaterials', label: 'mod_rawMaterials' },
      { key: 'dateReceiving', label: 'mod_dateReceiving' },
    ];
  } else if (currentModule === 'fermentation' || currentModule === 'distillation1' || currentModule === 'distillation2') {
    tabs = [
      { key: 'fermentation', label: 'mod_fermentation' },
      { key: 'distillation1', label: 'mod_distillation1' },
      { key: 'distillation2', label: 'mod_distillation2' },
    ];
  }

  const records = getData(storeKey);

  container.innerHTML = `
    ${tabs ? `
      <div class="tab-bar">
        ${tabs.map(tb => `
          <button class="tab-btn ${currentModule === tb.key ? 'active' : ''}" data-tab="${tb.key}">${t(tb.label)}</button>
        `).join('')}
      </div>
    ` : ''}

    ${hasPermission('canExportData') && records.length ? `
      <div style="text-align:right;margin-bottom:12px;">
        <button class="btn btn-secondary" id="export-btn" style="flex:none;padding:8px 16px;font-size:12px;">
          <i data-feather="download" style="width:14px;height:14px;vertical-align:middle;margin-right:4px;"></i>${t('exportCSV')}
        </button>
      </div>
    ` : ''}

    <div class="section-title">${t('recentEntries')} (${records.length})</div>

    ${records.length === 0 ? `
      <div class="empty-state">
        <i data-feather="inbox"></i>
        <p>${t('noData')}</p>
        ${hasPermission('canAddRecords') ? `<p style="font-size:12px;color:var(--text-muted);margin-top:4px;">${t('tapPlusToAdd')}</p>` : ''}
      </div>
    ` : `
      <div class="record-list">
        ${records.map(r => renderRecordItem(r)).join('')}
      </div>
    `}
  `;

  // FAB
  if (hasPermission('canAddRecords')) {
    const fab = el('button', 'fab-add', '<i data-feather="plus"></i>');
    fab.addEventListener('click', () => {
      editingRecord = null;
      currentView = 'form';
      _navDirection = 'forward';
      renderApp();
    });
    container.appendChild(fab);
  }

  // Bind tabs (save/restore scroll per tab)
  container.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const sc = $('#screen-content');
      if (sc) _scrollPositions[(currentModule || currentScreen) + ':' + currentView] = sc.scrollTop;
      currentModule = btn.dataset.tab;
      currentView = 'list';
      renderApp();
    });
  });

  // Bind export
  const exportBtn = container.querySelector('#export-btn');
  if (exportBtn) {
    exportBtn.addEventListener('click', () => {
      exportToCSV(storeKey, currentModule + '_' + todayStr() + '.csv');
      showToast(t('exportCSV') + ' ✓');
    });
  }

  // Bind approve buttons (bottling quick-approve for admin)
  container.querySelectorAll('.approve-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (records.find(r => r.id === btn.dataset.id)) {
        updateRecord(storeKey, btn.dataset.id, { decision: 'approved' });
        syncModuleToSheets(currentModule);
        syncInventorySnapshot('approve');
        renderApp();
      }
    });
  });

  // Bind record items
  container.querySelectorAll('.record-item').forEach(item => {
    item.addEventListener('click', () => {
      editingRecord = records.find(r => r.id === item.dataset.id);
      currentView = 'detail';
      _navDirection = 'forward';
      renderApp();
    });
  });
}

function renderRecordItem(r) {
  let title = '';
  let details = '';
  let badge = '';

  switch (currentModule) {
    case 'rawMaterials':
      title = r.item || r.category || '-';
      details = `${t('rm_supplier')}: ${r.supplier || '-'} &bull; ${r.weight || '-'} ${r.unit || ''}`;
      break;
    case 'dateReceiving':
      title = r.supplier || '-';
      details = `${r.weight || '-'} kg`;
      break;
    case 'fermentation': {
      const crates = r.datesCrates !== undefined ? r.datesCrates : Math.round((parseFloat(r.datesKg) || 0) / 20);
      title = `${r.tankSize || '-'}L ${t('fm_tankSize')}`;
      details = `${crates} ${t('fm_datesCrates').split('(')[0].trim()}`;
      break;
    }
    case 'distillation1':
      title = r.type ? t(r.type) : '-';
      details = `${t('d1_stillName')}: ${r.stillName ? t(r.stillName) : '-'} &bull; ${r.distilledQty || '-'} L`;
      break;
    case 'distillation2':
      title = `${r.batchNumber || '-'} (${r.productType ? t(r.productType) : '-'})`;
      details = `${r.initAlcohol || '-'}% &bull; ${r.quantity || '-'} L`;
      break;
    case 'bottling':
      title = r.drinkType ? t(r.drinkType) : '-';
      details = `${t('bt_batchNumber')}: ${r.batchNumber || '-'} &bull; ${r.bottleCount || '-'} ${t('bt_bottleCount').toLowerCase()}`;
      badge = r.decision === 'approved'
        ? `<span class="ri-badge approved">${t('approved')}</span>`
        : r.decision === 'notApproved'
          ? `<span class="ri-badge not-approved">${t('notApproved')}</span>`
          : `<span class="ri-badge pending">${t('bt_pendingApproval')}</span>${hasPermission('canApproveBottling') ? `<button class="approve-btn" data-id="${r.id}" style="margin-inline-start:6px;padding:2px 10px;font-size:11px;background:#22c55e;color:#fff;border:none;border-radius:6px;cursor:pointer;">${t('bt_approve')}</button>` : ''}`;
      break;
  }

  return `
    <div class="record-item" data-id="${r.id}">
      <div class="ri-top">
        <span class="ri-title">${title}</span>
        <span class="ri-date">${formatDate(r.date || r.createdAt)}</span>
      </div>
      <div class="ri-details">${details} ${badge}</div>
    </div>
  `;
}

// ============================================================
// MODULE DETAIL VIEW
// ============================================================
function renderModuleDetail(container) {
  if (!editingRecord) { currentView = 'list'; renderApp(); return; }
  const r = editingRecord;

  const fields = getModuleFields(currentModule);
  let html = '<div class="detail-card">';

  fields.forEach(f => {
    let val = r[f.key];
    if (f.type === 'toggle') val = val ? t('yes') : t('no');
    else if (f.type === 'select' && val) val = f.options ? (f.options.find(o => o.value === val)?.labelKey ? t(f.options.find(o => o.value === val).labelKey) : val) : val;
    else if (f.type === 'date') val = formatDate(val);
    if (val === undefined || val === null || val === '') val = '-';

    html += `<div class="detail-row"><span class="dl">${t(f.labelKey)}</span><span class="dv">${val}</span></div>`;
  });

  if (r.notes) {
    html += `<div class="detail-row"><span class="dl">${t('notes')}</span><span class="dv">${r.notes}</span></div>`;
  }

  html += '</div>';

  // Action buttons
  html += '<div class="form-actions">';
  if (hasPermission('canEditRecords')) {
    html += `<button class="btn btn-primary" id="edit-record-btn">${t('edit')}</button>`;
  }
  if (hasPermission('canDeleteRecords')) {
    html += `<button class="btn btn-danger" id="delete-record-btn">${t('delete')}</button>`;
  }
  html += '</div>';

  container.innerHTML = html;

  // Bind
  const editBtn = container.querySelector('#edit-record-btn');
  if (editBtn) {
    editBtn.addEventListener('click', () => {
      currentView = 'form';
      _navDirection = 'forward';
      renderApp();
    });
  }

  const delBtn = container.querySelector('#delete-record-btn');
  if (delBtn) {
    delBtn.addEventListener('click', () => {
      showManagerPasswordModal(() => {
        deleteRecord(STORE_KEYS[currentModule], editingRecord.id);
        syncModuleToSheets(currentModule);
        syncInventorySnapshot('delete');
        editingRecord = null;
        currentView = 'list';
        _navDirection = 'back';
        renderApp();
        showToast(t('delete') + ' ✓');
      });
    });
  }
}

// ============================================================
// MODULE FORM VIEW
// ============================================================
function renderModuleForm(container) {
  const fields = getModuleFields(currentModule);
  const isEdit = editingRecord !== null;

  let html = '<div class="form-container">';

  fields.forEach(f => {
    const val = isEdit ? (editingRecord[f.key] ?? '') : (f.default ?? '');
    html += renderFormField(f, val);
  });

  // Notes field (all modules)
  const notesVal = isEdit ? (editingRecord.notes || '') : '';
  html += `
    <div class="form-group">
      <label class="form-label">${t('notes')}</label>
      <textarea class="form-textarea" id="field-notes" placeholder="${t('addNote')}">${notesVal}</textarea>
    </div>
  `;

  // Signature for bottling
  if (currentModule === 'bottling') {
    html += `
      <div class="form-group">
        <label class="form-label">${t('bt_qaSignature')}</label>
        <div class="sig-pad-wrapper">
          <canvas id="sig-canvas"></canvas>
          <button class="sig-clear" id="sig-clear">${t('clearSignature')}</button>
        </div>
      </div>
    `;
  }

  html += `
    <div class="form-actions">
      <button class="btn btn-secondary" id="form-cancel">${t('cancel')}</button>
      <button class="btn btn-primary" id="form-save">${t('save')}</button>
    </div>
  `;

  html += '</div>';
  container.innerHTML = html;

  // Init signature canvas
  if (currentModule === 'bottling') {
    initSignaturePad();
  }

  // Bind cascading dropdowns
  bindCascadingDropdowns();

  // Bind save/cancel
  container.querySelector('#form-cancel').addEventListener('click', () => {
    currentView = editingRecord ? 'detail' : 'list';
    if (!editingRecord) editingRecord = null;
    _navDirection = 'back';
    renderApp();
  });

  container.querySelector('#form-save').addEventListener('click', () => {
    saveCurrentForm();
  });

  // Bind custom "Add new" option for all selects
  bindCustomSelects();
}

function bindCustomSelects() {
  document.querySelectorAll('.custom-select-group').forEach(group => {
    const fieldKey = group.dataset.fieldKey;
    const select = group.querySelector('select');
    const form = group.querySelector('.custom-option-form');
    if (!select || !form) return;

    let prevValue = select.value;

    select.addEventListener('change', () => {
      if (select.value === '__ADD_NEW__') {
        form.style.display = '';
        const input = form.querySelector('.custom-option-input');
        if (input) { input.value = ''; input.focus(); }
        select.value = prevValue; // revert selection visually
      } else {
        prevValue = select.value;
        form.style.display = 'none';
      }
    });

    const cancelBtn = form.querySelector('.custom-opt-cancel');
    if (cancelBtn) {
      cancelBtn.addEventListener('click', () => {
        form.style.display = 'none';
        select.value = prevValue;
      });
    }

    const confirmBtn = form.querySelector('.custom-opt-confirm');
    if (confirmBtn) {
      confirmBtn.addEventListener('click', async () => {
        const input = form.querySelector('.custom-option-input');
        const newVal = input ? input.value.trim() : '';
        if (!newVal) { showToast(t('required')); return; }

        await addCustomOption(fieldKey, newVal);

        // Add option to select and pick it
        const opt = document.createElement('option');
        opt.value = newVal;
        opt.textContent = newVal;
        // Insert before the __ADD_NEW__ option
        const addNewOpt = select.querySelector('option[value="__ADD_NEW__"]');
        if (addNewOpt) select.insertBefore(opt, addNewOpt);
        else select.appendChild(opt);

        select.value = newVal;
        prevValue = newVal;
        form.style.display = 'none';
        showToast(t('optionAdded'));
      });
    }
  });
}

// bindSupplierAddNew is replaced by bindCustomSelects() — see below

function renderFormField(f, val) {
  const reqMark = f.required ? '<span class="req">*</span>' : '';

  switch (f.type) {
    case 'date':
      return `
        <div class="form-group">
          <label class="form-label">${t(f.labelKey)}${reqMark}</label>
          <input type="date" class="form-input" id="field-${f.key}" value="${val || todayStr()}">
        </div>`;

    case 'number':
      return `
        <div class="form-group">
          <label class="form-label">${t(f.labelKey)}${reqMark}</label>
          <input type="number" class="form-input" id="field-${f.key}" value="${val}" step="${f.step || 'any'}" min="${f.min ?? ''}" max="${f.max ?? ''}" placeholder="${f.placeholder || ''}">
        </div>`;

    case 'text':
      const display = f.hidden ? 'display:none' : '';
      return `
        <div class="form-group" style="${display}">
          <label class="form-label">${t(f.labelKey)}${reqMark}</label>
          <input type="text" class="form-input" id="field-${f.key}" value="${val}" placeholder="${f.placeholder || ''}">
        </div>`;


    case 'select': {
      const customOpts = getCustomOptions(f.key);
      const allCustom = customOpts.filter(c => !(f.options || []).some(o => (o.value || o) === c));
      const skipAddNew = f.noCustom === true;
      return `
        <div class="form-group custom-select-group" data-field-key="${f.key}">
          <label class="form-label">${t(f.labelKey)}${reqMark}</label>
          <select class="form-select" id="field-${f.key}">
            <option value="">${t('selectOne')}</option>
            ${(f.options || []).map(o => {
              const optVal = o.value || o;
              const optLabel = o.labelKey ? t(o.labelKey) : (o.label || o);
              return `<option value="${optVal}" ${val === optVal ? 'selected' : ''}>${optLabel}</option>`;
            }).join('')}
            ${allCustom.map(c => `<option value="${c}" ${val === c ? 'selected' : ''}>${c}</option>`).join('')}
            ${!skipAddNew ? `<option value="__ADD_NEW__">${t('addNewOption')}</option>` : ''}
          </select>
          ${!skipAddNew ? `
          <div class="custom-option-form" id="custom-form-${f.key}" style="display:none;">
            <input type="text" class="form-input custom-option-input" id="custom-input-${f.key}" placeholder="${t('newOptionPlaceholder')}">
            <div class="custom-option-actions">
              <button class="btn btn-secondary custom-opt-cancel" data-fkey="${f.key}">${t('cancel')}</button>
              <button class="btn btn-primary custom-opt-confirm" data-fkey="${f.key}">${t('confirm')}</button>
            </div>
          </div>
          ` : ''}
        </div>`; }


    case 'cascading-select':
      return `
        <div class="form-group">
          <label class="form-label">${t(f.labelKey)}${reqMark}</label>
          <select class="form-select" id="field-${f.key}" data-cascade-parent="${f.parentKey}">
            <option value="">${t('selectOne')}</option>
          </select>
        </div>`;

    case 'toggle':
      const checked = val === true || val === 'true' ? 'checked' : '';
      return `
        <div class="form-group">
          <div class="toggle-row">
            <span class="toggle-label">${t(f.labelKey)}${reqMark}</span>
            <label class="toggle-switch">
              <input type="checkbox" id="field-${f.key}" ${checked}>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>`;

    case 'time-range':
      const parts = (val || '').split('-');
      return `
        <div class="form-group">
          <label class="form-label">${t(f.labelKey)}</label>
          <div class="time-range-row">
            <input type="time" class="form-input" id="field-${f.key}-start" value="${parts[0] || ''}">
            <span>—</span>
            <input type="time" class="form-input" id="field-${f.key}-end" value="${parts[1] || ''}">
          </div>
        </div>`;

    case 'decision':
      return `
        <div class="form-group">
          <label class="form-label">${t(f.labelKey)}${reqMark}</label>
          <div style="display:flex;gap:8px;">
            <button class="btn ${val === 'approved' ? 'btn-success' : 'btn-secondary'}" data-decision="approved" id="field-${f.key}-approved" style="flex:1">${t('approved')}</button>
            <button class="btn ${val === 'notApproved' ? 'btn-danger' : 'btn-secondary'}" data-decision="notApproved" id="field-${f.key}-notApproved" style="flex:1">${t('notApproved')}</button>
          </div>
          <input type="hidden" id="field-${f.key}" value="${val || ''}">
        </div>`;

    default:
      return '';
  }
}

function bindCascadingDropdowns() {
  // Raw materials: category -> item
  const catSelect = document.querySelector('#field-category');
  const itemSelect = document.querySelector('#field-item');

  if (catSelect && itemSelect) {
    const updateItems = () => {
      const cat = catSelect.value;
      const items = ITEMS_BY_CATEGORY[cat] || [];
      itemSelect.innerHTML = `<option value="">${t('selectOne')}</option>` +
        items.map(i => `<option value="${i}">${i}</option>`).join('');
    };
    catSelect.addEventListener('change', updateItems);

    // If editing, populate items for current category
    if (editingRecord && editingRecord.category) {
      catSelect.value = editingRecord.category;
      updateItems();
      if (editingRecord.item) itemSelect.value = editingRecord.item;
    }
  }

  // Decision buttons
  document.querySelectorAll('[data-decision]').forEach(btn => {
    btn.addEventListener('click', () => {
      const decision = btn.dataset.decision;
      const hiddenInput = document.querySelector('#field-decision');
      if (hiddenInput) hiddenInput.value = decision;

      // Update button styles
      const approvedBtn = document.querySelector('#field-decision-approved');
      const notApprovedBtn = document.querySelector('#field-decision-notApproved');
      if (approvedBtn) {
        approvedBtn.className = `btn ${decision === 'approved' ? 'btn-success' : 'btn-secondary'}`;
        approvedBtn.style.flex = '1';
      }
      if (notApprovedBtn) {
        notApprovedBtn.className = `btn ${decision === 'notApproved' ? 'btn-danger' : 'btn-secondary'}`;
        notApprovedBtn.style.flex = '1';
      }
    });
  });

  // Auto-calculate number of crates from tank size (fermentation)
  // Formula: tank_size * 0.28 kg of dates / 20 kg per crate
  const tankSelect = document.querySelector('#field-tankSize');
  const datesCratesInput = document.querySelector('#field-datesCrates');
  if (tankSelect && datesCratesInput) {
    tankSelect.addEventListener('change', () => {
      const size = parseFloat(tankSelect.value) || 0;
      datesCratesInput.value = Math.round(size * 0.28 / 20).toString();
    });
  }
}

function saveCurrentForm() {
  const fields = getModuleFields(currentModule);
  const record = {};

  // Clear previous validation errors
  document.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));
  document.querySelectorAll('.field-error-msg').forEach(el => el.remove());

  // Validate required fields with inline error highlighting
  const missing = [];
  fields.forEach(f => {
    if (!f.required) return;
    const fieldEl = document.querySelector(`#field-${f.key}`);
    const val = fieldEl ? (fieldEl.type === 'checkbox' ? null : fieldEl.value) : null;
    if (!val || val.trim() === '') {
      missing.push(t(f.labelKey));
      if (fieldEl) {
        fieldEl.classList.add('field-error');
        const errMsg = document.createElement('div');
        errMsg.className = 'field-error-msg';
        errMsg.textContent = t('required');
        fieldEl.parentElement.appendChild(errMsg);
      }
    }
  });
  if (missing.length > 0) {
    showToast(`${t('required')}: ${missing.join(', ')}`);
    // Scroll to first error
    const firstErr = document.querySelector('.field-error');
    if (firstErr) firstErr.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return;
  }

  fields.forEach(f => {
    if (f.type === 'toggle') {
      const el = document.querySelector(`#field-${f.key}`);
      record[f.key] = el ? el.checked : false;
    } else if (f.type === 'time-range') {
      const startEl = document.querySelector(`#field-${f.key}-start`);
      const endEl = document.querySelector(`#field-${f.key}-end`);
      record[f.key] = (startEl?.value || '') + '-' + (endEl?.value || '');
    } else {
      const el = document.querySelector(`#field-${f.key}`);
      record[f.key] = el ? (el.type === 'checkbox' ? el.checked : el.value) : '';
    }
  });

  // Guard: if any select still has __ADD_NEW__ selected, block save
  for (const f of fields) {
    if (f.type === 'select' && record[f.key] === '__ADD_NEW__') {
      showToast(`${t('required')}: ${t(f.labelKey)}`);
      return;
    }
  }

  // Notes
  const notesEl = document.querySelector('#field-notes');
  record.notes = notesEl ? notesEl.value : '';

  // Signature
  if (currentModule === 'bottling' && signatureCanvas) {
    // Detect blank canvas by checking if any non-transparent pixel exists
    const ctx = signatureCanvas.getContext('2d');
    const pixelData = ctx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height).data;
    const isSigned = pixelData.some((v, i) => i % 4 === 3 && v > 0);
    if (!isSigned) {
      showToast(`${t('required')}: ${t('bt_qaSignature')}`);
      return;
    }
    record.signature = signatureCanvas.toDataURL();
  }

  // Date field (use the date field or today)
  if (!record.date) record.date = todayStr();

  // Show loading state on save button
  const saveBtn = document.querySelector('#form-save');
  if (saveBtn) saveBtn.classList.add('is-loading');

  const storeKey = STORE_KEYS[currentModule];

  if (editingRecord) {
    updateRecord(storeKey, editingRecord.id, record);
  } else {
    addRecord(storeKey, record);
  }

  showToast(t('saved'));
  syncModuleToSheets(currentModule);
  syncInventorySnapshot('save');
  editingRecord = null;
  currentView = 'list';
  _navDirection = 'back';
  renderApp();
}

// ============================================================
// SIGNATURE PAD
// ============================================================
function initSignaturePad() {
  signatureCanvas = document.querySelector('#sig-canvas');
  if (!signatureCanvas) return;

  const rect = signatureCanvas.parentElement.getBoundingClientRect();
  signatureCanvas.width = rect.width;
  signatureCanvas.height = 120;
  sigCtx = signatureCanvas.getContext('2d');
  sigCtx.strokeStyle = '#e8e8f0';
  sigCtx.lineWidth = 2;
  sigCtx.lineCap = 'round';

  sigDrawing = false;

  const getPos = (e) => {
    const r = signatureCanvas.getBoundingClientRect();
    const touch = e.touches ? e.touches[0] : e;
    return { x: touch.clientX - r.left, y: touch.clientY - r.top };
  };

  signatureCanvas.addEventListener('mousedown', e => { sigDrawing = true; sigCtx.beginPath(); const p = getPos(e); sigCtx.moveTo(p.x, p.y); });
  signatureCanvas.addEventListener('mousemove', e => { if (!sigDrawing) return; const p = getPos(e); sigCtx.lineTo(p.x, p.y); sigCtx.stroke(); });
  signatureCanvas.addEventListener('mouseup', () => { sigDrawing = false; });

  signatureCanvas.addEventListener('touchstart', e => { e.preventDefault(); sigDrawing = true; sigCtx.beginPath(); const p = getPos(e); sigCtx.moveTo(p.x, p.y); }, { passive: false });
  signatureCanvas.addEventListener('touchmove', e => { e.preventDefault(); if (!sigDrawing) return; const p = getPos(e); sigCtx.lineTo(p.x, p.y); sigCtx.stroke(); }, { passive: false });
  signatureCanvas.addEventListener('touchend', () => { sigDrawing = false; });

  const clearBtn = document.querySelector('#sig-clear');
  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      sigCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    });
  }
}

// ============================================================
// INVENTORY VIEW
// ============================================================

// Returns records where createdAt is at least 60 seconds old (1-min buffer).
// Also returns the count of pending (< 1 min) records for the badge.
function getBufferedRecords(key) {
  const all = getData(key);
  const cutoff = Date.now() - 60 * 1000;
  const visible = all.filter(r => !r.createdAt || new Date(r.createdAt).getTime() <= cutoff);
  const pending = all.length - visible.length;
  return { visible, pending };
}

// Schedule a re-render of inventory after oldest pending record becomes visible.
let _invRefreshTimer = null;
function scheduleInventoryRefresh(container) {
  if (_invRefreshTimer) clearTimeout(_invRefreshTimer);
  const all = [
    ...getData(STORE_KEYS.bottling),
    ...getData(STORE_KEYS.rawMaterials),
    ...getData(STORE_KEYS.dateReceiving),
    ...getData(STORE_KEYS.fermentation),
  ];
  const cutoff = Date.now() - 60 * 1000;
  const pending = all.filter(r => r.createdAt && new Date(r.createdAt).getTime() > cutoff);
  if (pending.length === 0) return;

  // Find the one that will become visible soonest
  const earliest = Math.min(...pending.map(r => new Date(r.createdAt).getTime()));
  const delay = earliest + 60 * 1000 - Date.now() + 200; // +200ms margin
  _invRefreshTimer = setTimeout(() => {
    if (currentModule === 'inventory') {
      renderApp();
    }
  }, Math.max(delay, 1000));
}

function renderInventory(container) {
  // 1-minute buffer: only count records older than 60s
  const { visible: bottlingRecords, pending: pendingBottling } = getBufferedRecords(STORE_KEYS.bottling);
  const { visible: rawRecords, pending: pendingRaw } = getBufferedRecords(STORE_KEYS.rawMaterials);
  const { visible: dateRecords, pending: pendingDates } = getBufferedRecords(STORE_KEYS.dateReceiving);
  const { visible: fermRecords, pending: pendingFerm } = getBufferedRecords(STORE_KEYS.fermentation);

  const totalPending = pendingBottling + pendingRaw + pendingDates + pendingFerm;

  const bottleInv = {};
  DRINK_TYPES.forEach(dt => { bottleInv[dt] = 0; });
  bottlingRecords.forEach(r => {
    if (r.drinkType && r.decision === 'approved') {
      const count = parseInt(r.bottleCount) || 0;
      bottleInv[r.drinkType] = (bottleInv[r.drinkType] || 0) + count;
    }
  });

  const rawInv = {};
  rawRecords.forEach(r => {
    const key = r.item || r.category || 'Unknown';
    const qty = parseFloat(r.weight) || 0;
    rawInv[key] = (rawInv[key] || 0) + qty;
  });

  const totalDatesReceived = dateRecords.reduce((sum, r) => sum + (parseFloat(r.weight) || 0), 0);
  // Support both new records (datesCrates) and legacy records (datesKg stored as kg)
  const totalDatesInFerm = fermRecords.reduce((sum, r) => {
    if (r.datesCrates !== undefined && r.datesCrates !== '') {
      return sum + (parseFloat(r.datesCrates) || 0) * 20;
    }
    return sum + (parseFloat(r.datesKg) || 0);
  }, 0);
  const availableDates = Math.max(0, totalDatesReceived - totalDatesInFerm);
  const activeFerm = fermRecords.filter(r => !r.sentToDistillation).length;

  container.innerHTML = `
    ${totalPending > 0 ? `
    <div class="inv-pending-banner">
      <i data-feather="clock" style="width:14px;height:14px;margin-inline-end:6px;"></i>
      ${t('pendingChanges').replace('{n}', totalPending)}
    </div>` : ''}

    <div class="tab-bar">
      <button class="tab-btn active" data-inv-tab="bottles">${t('mod_bottleInventory')}</button>
      <button class="tab-btn" data-inv-tab="raw">${t('mod_rawInventory')}</button>
    </div>

    <div id="inv-bottles">
      <div class="inv-section">
        <div class="stats-row" style="grid-template-columns:1fr 1fr 1fr;margin-bottom:16px;">
          <div class="stat-card">
            <div class="stat-num" style="color:var(--success)">${availableDates.toFixed(0)}</div>
            <div class="stat-label">${t('inv_dates')}</div>
            <div style="font-size:10px;opacity:0.6;margin-top:2px;">+${totalDatesReceived.toFixed(0)} / -${totalDatesInFerm.toFixed(0)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-num">${activeFerm}</div>
            <div class="stat-label">${t('mod_fermentation')}</div>
          </div>
          <div class="stat-card">
            <div class="stat-num" style="color:var(--warning,#f59e0b)">${totalDatesInFerm.toFixed(0)}</div>
            <div class="stat-label">${t('inv_datesUsed')}</div>
          </div>
        </div>

        <h3>${t('mod_bottleInventory')}</h3>
        <table class="inv-table">
          <thead><tr><th>${t('inv_drinkType')}</th><th style="text-align:right">${t('inv_warehouseQty')}</th></tr></thead>
          <tbody>
            ${DRINK_TYPES.map(dt => {
    const qty = bottleInv[dt] || 0;
    const cls = qty > 0 ? 'stock-positive' : qty < 0 ? 'stock-negative' : 'stock-zero';
    return `<tr><td>${t(dt)}</td><td style="text-align:right" class="${cls}">${qty}</td></tr>`;
  }).join('')}
          </tbody>
        </table>
      </div>
    </div>

    <div id="inv-raw" style="display:none;">
      <div class="inv-section">
        <h3>${t('mod_rawInventory')}</h3>
        <table class="inv-table">
          <thead><tr><th>${t('inv_item')}</th><th style="text-align:right">${t('inv_stock')}</th></tr></thead>
          <tbody>
            ${Object.entries(rawInv).length === 0 ? `<tr><td colspan="2" style="text-align:center">${t('noData')}</td></tr>` :
      Object.entries(rawInv).map(([item, qty]) => {
        const cls = qty > 0 ? 'stock-positive' : qty < 0 ? 'stock-negative' : 'stock-zero';
        return `<tr><td>${item}</td><td style="text-align:right" class="${cls}">${qty}</td></tr>`;
      }).join('')
    }
          </tbody>
        </table>
      </div>
    </div>


  `;

  // Bind tabs
  container.querySelectorAll('[data-inv-tab]').forEach(btn => {
    btn.addEventListener('click', () => {
      container.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.invTab;
      container.querySelector('#inv-bottles').style.display = tab === 'bottles' ? '' : 'none';
      container.querySelector('#inv-raw').style.display = tab === 'raw' ? '' : 'none';
      container.querySelector('#inv-versions').style.display = tab === 'versions' ? '' : 'none';
    });
  });

  // Version Detail View
  container.querySelectorAll('.inv-ver-item').forEach(item => {
    item.addEventListener('click', () => {
      const verId = item.dataset.ver;
      const ver = versions.find(v => String(v.version) === verId);
      if (ver) {
        let gapSummary = Object.entries(ver.gaps)
          .filter(([_, diff]) => diff !== 0)
          .map(([key, diff]) => `${key}: ${diff > 0 ? '+' : ''}${diff}`)
          .join('\n');
        alert(`${t('versionLabel')} ${ver.version} ${t('gapsLabel')}:\n${gapSummary || t('noGaps')}`);
      }
    });
  });

  // Schedule auto-refresh when pending records become visible
  scheduleInventoryRefresh(container);
}

// ============================================================
// SPIRIT PIPELINE SCREEN
// ============================================================
function renderSpiritStock(container) {
  const d1Records = getData(STORE_KEYS.distillation1);
  const d2Records = getData(STORE_KEYS.distillation2);
  const bottlingRecords = getData(STORE_KEYS.bottling);

  // D1 totals
  const d1Produced = d1Records.reduce((sum, r) => sum + (parseFloat(r.distilledQty) || 0), 0);
  const d1Consumed = d2Records.reduce((sum, r) => sum + (parseFloat(r.d1InputQty) || 0), 0);
  const d1Available = Math.max(0, d1Produced - d1Consumed);
  const d1HasConsumed = d1Consumed > 0;

  // D2 totals
  const d2Produced = d2Records.reduce((sum, r) => sum + (parseFloat(r.quantity) || 0), 0);
  const d2Consumed = bottlingRecords.reduce((sum, r) => sum + (parseFloat(r.d2InputQty) || 0), 0);
  const d2Available = Math.max(0, d2Produced - d2Consumed);
  const d2HasConsumed = d2Consumed > 0;

  const hasAnyData = d1Records.length > 0 || d2Records.length > 0;

  if (!hasAnyData) {
    container.innerHTML = `
      <div class="empty-state">
        <i data-feather="droplet"></i>
        <p>${t('spirit_noData')}</p>
      </div>`;
    return;
  }

  const fmtL = n => n.toFixed(1) + ' L';

  container.innerHTML = `
    <div class="section-title">${t('spirit_pipeline')}</div>

    <div class="spirit-pipeline">

      <!-- D1 Stage -->
      <div class="spirit-stage">
        <div class="spirit-stage-header">
          <i data-feather="zap" style="width:16px;height:16px;"></i>
          <span>${t('spirit_d1Label')}</span>
        </div>
        <div class="spirit-stage-stats">
          <div class="spirit-stat">
            <span class="spirit-stat-label">${t('spirit_produced')}</span>
            <span class="spirit-stat-val">${fmtL(d1Produced)}</span>
          </div>
          ${d1HasConsumed ? `
          <div class="spirit-stat">
            <span class="spirit-stat-label">${t('spirit_consumed')}</span>
            <span class="spirit-stat-val spirit-stat-out">− ${fmtL(d1Consumed)}</span>
          </div>` : ''}
          <div class="spirit-stat spirit-stat-available">
            <span class="spirit-stat-label">${t('spirit_available')}</span>
            <span class="spirit-stat-val spirit-stat-in">${fmtL(d1Available)}</span>
          </div>
        </div>
        <div class="spirit-count-note">${d1Records.length} ${t('recentEntries').toLowerCase()}</div>
      </div>

      <div class="spirit-arrow"><i data-feather="arrow-down"></i></div>

      <!-- D2 Stage -->
      <div class="spirit-stage">
        <div class="spirit-stage-header">
          <i data-feather="filter" style="width:16px;height:16px;"></i>
          <span>${t('spirit_d2Label')}</span>
        </div>
        <div class="spirit-stage-stats">
          <div class="spirit-stat">
            <span class="spirit-stat-label">${t('spirit_produced')}</span>
            <span class="spirit-stat-val">${fmtL(d2Produced)}</span>
          </div>
          ${d2HasConsumed ? `
          <div class="spirit-stat">
            <span class="spirit-stat-label">${t('spirit_consumed')}</span>
            <span class="spirit-stat-val spirit-stat-out">− ${fmtL(d2Consumed)}</span>
          </div>` : ''}
          <div class="spirit-stat spirit-stat-available">
            <span class="spirit-stat-label">${t('spirit_available')}</span>
            <span class="spirit-stat-val spirit-stat-in">${fmtL(d2Available)}</span>
          </div>
        </div>
        <div class="spirit-count-note">${d2Records.length} ${t('recentEntries').toLowerCase()}</div>
      </div>

      <div class="spirit-arrow"><i data-feather="arrow-down"></i></div>

      <!-- Ready to Bottle -->
      <div class="spirit-stage spirit-stage-final">
        <div class="spirit-stage-header">
          <i data-feather="package" style="width:16px;height:16px;"></i>
          <span>${t('spirit_readyToBottle')}</span>
        </div>
        <div class="spirit-stage-stats">
          <div class="spirit-stat spirit-stat-available">
            <span class="spirit-stat-label">${t('spirit_available')}</span>
            <span class="spirit-stat-val spirit-stat-in" style="font-size:22px;">${fmtL(d2Available)}</span>
          </div>
        </div>
      </div>

    </div>

    ${(!d1HasConsumed || !d2HasConsumed) ? `
    <div class="spirit-hint">
      <i data-feather="info" style="width:13px;height:13px;margin-inline-end:5px;vertical-align:middle;"></i>
      ${!d1HasConsumed && !d2HasConsumed
        ? 'Add "D1 Spirit Consumed" to D2 records and "D2 Spirit Consumed" to Bottling records to track net balances.'
        : !d1HasConsumed
          ? 'Add "D1 Spirit Consumed" to D2 records to track D1 net balance.'
          : 'Add "D2 Spirit Consumed" to Bottling records to track D2 net balance.'}
    </div>` : ''}
  `;
}

// ============================================================
// MODULE FIELD DEFINITIONS
// ============================================================
function getModuleFields(mod) {
  switch (mod) {
    case 'rawMaterials':
      return [
        {
          key: 'supplier', labelKey: 'rm_supplier', type: 'select', required: true,
          options: SUPPLIERS_RAW.map(s => ({ value: s, labelKey: s }))
        },
        { key: 'date', labelKey: 'rm_receiveDate', type: 'date', required: true, default: todayStr() },
        {
          key: 'category', labelKey: 'rm_category', type: 'select', required: true,
          options: CATEGORIES.map(c => ({ value: c, labelKey: c }))
        },
        { key: 'item', labelKey: 'rm_item', type: 'cascading-select', required: true, parentKey: 'category' },
        { key: 'weight', labelKey: 'rm_weight', type: 'number', required: true, step: '0.01', min: 0 },
        { key: 'expiry', labelKey: 'rm_expiry', type: 'date' },
        { key: 'tithing', labelKey: 'rm_tithing', type: 'toggle' },
        { key: 'healthCert', labelKey: 'rm_healthCert', type: 'toggle' },
        { key: 'kosher', labelKey: 'rm_kosher', type: 'toggle' },
      ];

    case 'dateReceiving':
      return [
        {
          key: 'supplier', labelKey: 'dr_supplier', type: 'select', required: true,
          options: SUPPLIERS_DATES.map(s => ({ value: s, labelKey: s }))
        },
        { key: 'date', labelKey: 'dr_receiveDate', type: 'date', required: true, default: todayStr() },
        { key: 'weight', labelKey: 'dr_weight', type: 'number', required: true, step: '0.1', min: 0 },
        { key: 'tithing', labelKey: 'dr_tithing', type: 'toggle' },
        {
          key: 'expiryPeriod', labelKey: 'dr_expiryPeriod', type: 'select',
          options: [
            { value: '1year', labelKey: 'dr_expiryPeriod_1year' },
            { value: 'custom', labelKey: 'dr_expiryPeriod_custom' },
          ]
        },
      ];

    case 'fermentation':
      return [
        { key: 'date', labelKey: 'fm_date', type: 'date', required: true, default: todayStr() },
        {
          key: 'tankSize', labelKey: 'fm_tankSize', type: 'select', required: true, noCustom: true,
          options: TANK_SIZES.map(s => ({ value: String(s), label: s + ' L' }))
        },
        { key: 'datesCrates', labelKey: 'fm_datesCrates', type: 'number', required: true, step: '1', min: '0' },
        { key: 'temperature', labelKey: 'fm_temperature', type: 'number', step: '0.1' },
        { key: 'sugar', labelKey: 'fm_sugar', type: 'number', step: '0.1' },
        { key: 'ph', labelKey: 'fm_ph', type: 'number', step: '0.01', min: 0, max: 14 },
        { key: 'sentToDistillation', labelKey: 'fm_sentToDistillation', type: 'toggle' },
      ];

    case 'distillation1':
      return [
        { key: 'date', labelKey: 'd1_date', type: 'date', required: true, default: todayStr() },
        {
          key: 'type', labelKey: 'd1_type', type: 'select', required: true,
          options: D1_TYPES.map(t => ({ value: t, labelKey: t }))
        },
        {
          key: 'stillName', labelKey: 'd1_stillName', type: 'select', required: true,
          options: STILL_NAMES.map(s => ({ value: s, labelKey: s }))
        },
        { key: 'fermDate', labelKey: 'd1_fermDate', type: 'date' },
        { key: 'distQty', labelKey: 'd1_distQty', type: 'number', step: '0.1' },
        { key: 'initAlcohol', labelKey: 'd1_initAlcohol', type: 'number', step: '0.1', min: 0, max: 100 },
        { key: 'finalAlcohol', labelKey: 'd1_finalAlcohol', type: 'number', step: '0.1', min: 0, max: 100 },
        { key: 'temp', labelKey: 'd1_temp', type: 'number', step: '0.1', default: '99.9' },
        { key: 'timeRange', labelKey: 'd1_timeRange', type: 'time-range' },
        { key: 'distilledQty', labelKey: 'd1_distilledQty', type: 'number', required: true, step: '0.1' },
      ];

    case 'distillation2':
      return [
        { key: 'date', labelKey: 'd2_date', type: 'date', required: true, default: todayStr() },
        {
          key: 'productType', labelKey: 'd2_productType', type: 'select', required: true,
          options: D2_PRODUCT_TYPES.map(t => ({ value: t, labelKey: t }))
        },
        { key: 'd1Dates', labelKey: 'd2_d1Dates', type: 'text', placeholder: 'e.g. 1.1 / 2.1 / 5.1' },
        { key: 'batchNumber', labelKey: 'd2_batchNumber', type: 'text', required: true, placeholder: 'e.g. E51, A102, G7' },
        { key: 'initAlcohol', labelKey: 'd2_initAlcohol', type: 'number', step: '0.1', min: 0, max: 100 },
        { key: 'headSep', labelKey: 'd2_headSep', type: 'toggle', default: true },
        { key: 'tailAlcohol', labelKey: 'd2_tailAlcohol', type: 'number', step: '0.01', default: '0.55' },
        { key: 'temp', labelKey: 'd2_temp', type: 'number', step: '0.1', default: '99.9' },
        { key: 'timeRange', labelKey: 'd2_timeRange', type: 'time-range' },
        { key: 'quantity', labelKey: 'd2_quantity', type: 'number', required: true, step: '0.1' },
        { key: 'd1InputQty', labelKey: 'd2_d1InputQty', type: 'number', step: '0.1', min: 0 },
      ];

    case 'bottling':
      return [
        {
          key: 'drinkType', labelKey: 'bt_drinkType', type: 'select', required: true,
          options: DRINK_TYPES.map(t => ({ value: t, labelKey: t }))
        },
        { key: 'date', labelKey: 'bt_bottlingDate', type: 'date', required: true, default: todayStr() },
        { key: 'batchNumber', labelKey: 'bt_batchNumber', type: 'text', required: true, placeholder: 'e.g. E51, A102' },
        { key: 'barrelNumber', labelKey: 'bt_barrelNumber', type: 'text', placeholder: 'e.g. B1, B2' },
        { key: 'd2Date', labelKey: 'bt_d2Date', type: 'date' },
        { key: 'alcohol', labelKey: 'bt_alcohol', type: 'number', required: true, step: '0.001', min: 0, max: 1 },
        { key: 'filtered', labelKey: 'bt_filtered', type: 'toggle' },
        {
          key: 'color', labelKey: 'bt_color', type: 'select', noCustom: true,
          options: [
            { value: 'normal', labelKey: 'normal' },
            { value: 'abnormal', labelKey: 'abnormal' },
          ]
        },
        {
          key: 'taste', labelKey: 'bt_taste', type: 'select', noCustom: true,
          options: [
            { value: 'normal', labelKey: 'normal' },
            { value: 'abnormal', labelKey: 'abnormal' },
          ]
        },
        { key: 'contaminants', labelKey: 'bt_contaminants', type: 'toggle' },
        { key: 'bottleCount', labelKey: 'bt_bottleCount', type: 'number', required: true, min: 0 },
        { key: 'd2InputQty', labelKey: 'bt_d2InputQty', type: 'number', step: '0.1', min: 0 },
        ...(hasPermission('canApproveBottling') ? [
          { key: 'decision', labelKey: 'bt_decision', type: 'decision', required: true },
        ] : []),
      ];

    default:
      return [];
  }
}

// ============================================================
// BACKOFFICE UI
// ============================================================

function renderBackoffice(container) {
  if (!hasPermission('canManageUsers')) {
    container.innerHTML = `<div class="perm-overlay"><i data-feather="lock"></i><p>${t('perm_denied')}</p></div>`;
    return;
  }

  const users = getUsers();

  if (currentView === 'form') {
    renderUserForm(container);
    return;
  }

  container.innerHTML = `
    <div class="section-title">${t('userManagement')}</div>
    <p class="backoffice-subtitle">${t('backofficeSubtitle')}</p>

    <div class="permissions-legend">
      <div class="perm-legend-row">
        <span class="role-pill role-pill-admin">${t('role_admin')}</span>
        <span>${t('permAdmin')}</span>
      </div>
      <div class="perm-legend-row">
        <span class="role-pill role-pill-manager">${t('role_manager')}</span>
        <span>${t('permManager')}</span>
      </div>
      <div class="perm-legend-row">
        <span class="role-pill role-pill-worker">${t('role_worker')}</span>
        <span>${t('permWorker')}</span>
      </div>
    </div>

    <div class="record-list" style="margin-top:16px;">
      ${users.map(u => `
        <div class="record-item user-item" data-username="${u.username}">
          <div class="ri-top">
            <span class="ri-title">
              ${u.username}
              <span class="role-pill role-pill-${u.role}" style="margin-inline-start:6px;">${t('role_' + u.role)}</span>
            </span>
            <span class="ri-badge ${u.status === 'inactive' ? 'not-approved' : 'approved'}">
              ${u.status === 'inactive' ? t('inactive') : t('active')}
            </span>
          </div>
          <div class="ri-details">
            ${u.nameHe || u.name || '-'}${u.name ? ' &bull; ' + u.name : ''}
            <div style="font-size:10px; margin-top:4px; color:var(--text-muted);">
              ${t('lastActivity')}: ${u.lastActivity ? formatDate(u.lastActivity) : '-'}
            </div>
          </div>
        </div>
      `).join('')}
    </div>

    <div style="margin-top:24px;">
      <div class="section-title" style="margin-bottom:12px;">${t('sheetsIntegration')}</div>
      <a href="${INVENTORY_SHEET_URL}" target="_blank" rel="noopener noreferrer"
         id="inventory-sheet-link" class="btn btn-secondary"
         style="display:flex;align-items:center;gap:8px;margin-bottom:12px;text-decoration:none;">
        <i data-feather="external-link"></i> ${t('viewInventorySheet')}
      </a>
      <div style="display:flex;gap:10px;">
        <button class="btn btn-secondary" id="btn-sync-all-sheets" style="flex:1;">
          <i data-feather="refresh-cw"></i> ${t('sheetsSyncAll')}
        </button>
      </div>
    </div>

    <div style="margin-top:16px; display:flex; gap:10px;">
      <button class="btn btn-secondary" id="btn-export-all" style="flex:1;">
        <i data-feather="download"></i> ${t('exportAllData')}
      </button>
    </div>
  `;

  // FAB
  const fab = el('button', 'fab-add', '<i data-feather="user-plus"></i>');
  fab.id = 'add-user-btn';
  fab.addEventListener('click', () => {
    editingRecord = null;
    currentView = 'form';
    renderApp();
  });
  container.appendChild(fab);

  // Bind export
  const exportBtn = container.querySelector('#btn-export-all');
  if (exportBtn) {
    exportBtn.addEventListener('click', () => {
      if (confirm(t('confirmExport'))) {
        exportAllData();
      }
    });
  }

  // Bind Sync All — pushes every module to Sheets at once
  const syncAllBtn = container.querySelector('#btn-sync-all-sheets');
  if (syncAllBtn) {
    syncAllBtn.addEventListener('click', async () => {
      syncAllBtn.disabled = true;
      const origHtml = syncAllBtn.innerHTML;
      syncAllBtn.innerHTML = `<i data-feather="loader"></i> ${t('syncInProgress')}`;
      if (typeof feather !== 'undefined') feather.replace();

      ['rawMaterials', 'dateReceiving', 'fermentation', 'distillation1', 'distillation2', 'bottling']
        .forEach(m => syncModuleToSheets(m));
      syncInventorySnapshot('manual');

      // Wait for GAS to process, then verify via GET
      await new Promise(r => setTimeout(r, 4000));
      const check = await verifySyncStatus(t('mod_bottling'));
      console.log('[sync] Sync All verification:', check);

      syncAllBtn.disabled = false;
      syncAllBtn.innerHTML = origHtml;
      if (typeof feather !== 'undefined') feather.replace();

      if (check.verified && check.exists) {
        showToast(t('syncSuccess'));
      } else {
        showToast(t('sheetsSyncAll') + ' ✓');
      }
    });
  }

  // Bind user items to edit
  container.querySelectorAll('.user-item').forEach(item => {
    item.addEventListener('click', () => {
      const username = item.dataset.username;
      editingRecord = users.find(u => u.username === username);
      currentView = 'form';
      renderApp();
    });
  });
}

function renderUserForm(container) {
  const isEdit = !!editingRecord;
  const u = editingRecord || {};

  container.innerHTML = `
    <div class="section-title">${isEdit ? t('editUser') : t('addUser')}</div>
    <div class="form-container">
      
      <div class="form-group">
        <label class="form-label">${t('username')} <span class="req">*</span></label>
        <input type="text" class="form-input" id="bo-username" value="${u.username || ''}" ${isEdit ? 'disabled style="opacity:0.7"' : ''}>
      </div>
      
      ${!isEdit ? `
      <div class="form-group">
        <label class="form-label">${t('password')} <span class="req">*</span></label>
        <input type="password" class="form-input" id="bo-password" placeholder="${t('password')}">
      </div>
      ` : `
      <div class="form-group">
        <label class="form-label">${t('password')} <small>(${t('optional')})</small></label>
        <input type="password" class="form-input" id="bo-password" placeholder="${t('keepCurrentPassword')}">
      </div>
      `}
      
      <div class="form-group">
        <label class="form-label">${t('nameEnglish')} <span class="req">*</span></label>
        <input type="text" class="form-input" id="bo-name" value="${u.name || ''}">
      </div>

      <div class="form-group">
        <label class="form-label">${t('nameHebrew')}</label>
        <input type="text" class="form-input" id="bo-nameHe" value="${u.nameHe || ''}" dir="rtl">
      </div>

      <div class="form-group">
        <label class="form-label">${t('fullName')} (Thai)</label>
        <input type="text" class="form-input" id="bo-nameTh" value="${u.nameTh || ''}">
      </div>

      <div class="form-group">
        <label class="form-label">${t('selectRole')} <span class="req">*</span></label>
        <select class="form-select" id="bo-role">
          <option value="worker" ${u.role === 'worker' ? 'selected' : ''}>${t('role_worker')}</option>
          <option value="manager" ${u.role === 'manager' ? 'selected' : ''}>${t('role_manager')}</option>
          <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>${t('role_admin') || 'Admin'}</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">${t('status')}</label>
        <select class="form-select" id="bo-status">
          <option value="active" ${u.status !== 'inactive' ? 'selected' : ''}>${t('active')}</option>
          <option value="inactive" ${u.status === 'inactive' ? 'selected' : ''}>${t('inactive')}</option>
        </select>
      </div>

      <div class="login-error" id="bo-error"></div>

      <div class="form-actions">
        <button class="btn btn-secondary" id="bo-cancel">${t('cancel')}</button>
        ${isEdit ? `<button class="btn btn-danger" id="bo-delete">${t('deleteUser')}</button>` : ''}
        <button class="btn btn-primary" id="bo-save">${t('save')}</button>
      </div>
    </div>
  `;

  // Bind actions
  const cancelBtn = container.querySelector('#bo-cancel');
  if (cancelBtn) cancelBtn.addEventListener('click', () => {
    currentView = 'list';
    editingRecord = null;
    renderApp();
  });

  const deleteBtn = container.querySelector('#bo-delete');
  if (deleteBtn && isEdit) {
    deleteBtn.addEventListener('click', () => {
      if (u.username === 'admin') {
        showToast(t('cannotDeleteAdmin'));
        return;
      }
      if (u.username === getSession().username) {
        showToast(t('cannotDeleteSelf'));
        return;
      }
      showManagerPasswordModal(() => {
        deleteUserByUsername(u.username);
        showToast(t('delete') + ' ✓');
        currentView = 'list';
        editingRecord = null;
        renderApp();
      });
    });
  }

  const saveBtn = container.querySelector('#bo-save');
  if (saveBtn) saveBtn.addEventListener('click', () => {
    const errorEl = container.querySelector('#bo-error');
    errorEl.textContent = '';

    const usernameInput = container.querySelector('#bo-username');
    const passwordInput = container.querySelector('#bo-password');
    const nameInput = container.querySelector('#bo-name');
    const nameHeInput = container.querySelector('#bo-nameHe');
    const nameThInput = container.querySelector('#bo-nameTh');
    const roleInput = container.querySelector('#bo-role');
    const statusInput = container.querySelector('#bo-status');

    const username = usernameInput ? usernameInput.value.trim() : '';
    const password = passwordInput ? passwordInput.value : '';
    const name = nameInput ? nameInput.value.trim() : '';
    const nameHe = nameHeInput ? nameHeInput.value.trim() : '';
    const nameTh = nameThInput ? nameThInput.value.trim() : '';
    const role = roleInput ? roleInput.value : '';
    const status = statusInput ? statusInput.value : 'active';

    if (!username || !name || (!isEdit && !password)) {
      errorEl.textContent = t('signUpError_fillAll');
      return;
    }

    if (isEdit) {
      // Update
      const updates = { name, nameHe, nameTh, role, status };
      if (password) updates.password = password;

      const res = updateUser(username, updates);
      if (res.success) {
        showToast(t('saved'));
        currentView = 'list';
        editingRecord = null;
        renderApp();
      } else {
        errorEl.textContent = res.error;
      }
    } else {
      // Create
      const res = createUser({ username, password, name, nameHe, nameTh, role, status });
      if (res.success) {
        showToast(t('signUpSuccess'));
        currentView = 'list';
        editingRecord = null;
        renderApp();
      } else {
        errorEl.textContent = t(res.error) || res.error;
      }
    }
  });
}

// ============================================================
// ACCESS REQUESTS
// ============================================================

// Fire-and-forget notification to GAS webhook so admins get an email
function notifyAdminsOfRequest(request) {
  const url = SHEETS_SYNC_URL;
  if (!url) return;
  fetch(url, {
    method: 'POST',
    body: JSON.stringify({
      action: 'notify',
      type: 'access_request',
      name: request.name,
      email: request.email,
      requestedAt: request.requestedAt,
    }),
    mode: 'no-cors',
  }).catch(() => {});
}

function renderPendingRequests(container) {
  const requests = getPendingRequests();

  container.innerHTML = `
    <div style="padding:16px">
      <h2 style="font-size:17px;font-weight:700;margin-bottom:16px">${t('pendingRequestsTitle')}</h2>
      ${requests.length === 0
        ? `<div class="empty-state"><p>${t('pendingRequestsEmpty')}</p></div>`
        : requests.map(req => `
          <div class="record-item" id="req-card-${req.id}">
            <div class="ri-main">
              <div class="ri-title">${req.name}</div>
              <div class="ri-details">${req.email}<br><small>${new Date(req.requestedAt).toLocaleDateString()}</small></div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;padding:10px 12px">
              <div style="display:flex;gap:6px">
                <input type="password" id="pwd-${req.id}" placeholder="${t('setPassword')}"
                  style="flex:1;padding:8px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-input);color:var(--text);font-size:13px">
                <select id="role-${req.id}"
                  style="padding:8px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-input);color:var(--text);font-size:13px">
                  <option value="worker">${t('role_worker')}</option>
                  <option value="manager">${t('role_manager')}</option>
                  <option value="admin">${t('role_admin')}</option>
                </select>
              </div>
              <div style="display:flex;gap:6px">
                <button class="btn btn-primary" style="flex:1" onclick="handleApproveRequest('${req.id}')">${t('approveUser')}</button>
                <button class="btn btn-danger" style="flex:1" onclick="handleDenyRequest('${req.id}')">${t('denyUser')}</button>
              </div>
            </div>
          </div>`).join('')}
    </div>
  `;
}

function handleApproveRequest(requestId) {
  const pwd = ($(`#pwd-${requestId}`) || {}).value || '';
  const role = ($(`#role-${requestId}`) || {}).value || 'worker';
  if (!pwd) { alert(t('setPassword')); return; }
  const res = approveRequest(requestId, pwd, role);
  if (res.success) {
    renderApp();
  } else {
    alert(res.error || 'Error approving request');
  }
}

function handleDenyRequest(requestId) {
  denyRequest(requestId);
  renderApp();
}

// ============================================================
// AUTO HARD-REFRESH
// ============================================================
function scheduleHardRefresh(intervalMs = 30 * 60 * 1000) {
  setTimeout(() => location.reload(true), intervalMs);
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  if (typeof initFirebase === 'function') initFirebase();
  renderApp();
  scheduleHardRefresh();
});

    </script>
</body>

</html>